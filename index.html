<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Content Security Policy - Relaxed for local testing, tighten for production -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self' 'unsafe-inline' 'unsafe-eval';
        script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.tailwindcss.com https://cdn.jsdelivr.net;
        style-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://fonts.googleapis.com;
        font-src 'self' https://fonts.gstatic.com;
        img-src 'self' https: data:;
        connect-src 'self' http://localhost:3001 http://localhost:* https://api.etherscan.io https://api.blockchain.info https://mainnet.helius-rpc.com https://bsc-dataseed.binance.org https://api.avax.network https://polygon-rpc.com https://cryptologos.cc https://cdn.jsdelivr.net;
    ">
    
    <title>Wallet DNA - Decode Your On-Chain Genetics</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üß¨</text></svg>">
    
    <!-- External Scripts - SRI hashes removed for local testing compatibility -->
    <!-- For production deployment, generate proper SRI hashes -->
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Ethers.js -->
    <script 
        src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"
        crossorigin="anonymous">
    </script>
    
    <!-- Chart.js -->
    <script 
        src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"
        crossorigin="anonymous">
    </script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background: #0a0e1a;
            color: #fff;
            overflow-x: hidden;
        }
        
        /* Animated background gradient */
        .bg-animated {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 25%, #f093fb 50%, #4facfe 75%, #00f2fe 100%);
            background-size: 400% 400%;
            animation: gradientFlow 15s ease infinite;
        }
        
        @keyframes gradientFlow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        /* Glass card effect */
        .glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        /* Chain cards */
        .chain-btn {
            background: rgba(255, 255, 255, 0.03);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .chain-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.5s;
        }
        
        .chain-btn:hover::before {
            left: 100%;
        }
        
        .chain-btn:hover {
            transform: translateY(-8px) scale(1.02);
            border-color: #00f2fe;
            box-shadow: 0 12px 40px rgba(0, 242, 254, 0.3);
        }
        
        .chain-btn.active {
            border-color: #00f2fe;
            background: rgba(0, 242, 254, 0.1);
            box-shadow: 0 0 30px rgba(0, 242, 254, 0.4);
        }
        
        /* Buttons */
        .btn-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            background-size: 200% 200%;
            border: none;
            color: white;
            font-weight: 600;
            padding: 18px 36px;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.4s ease;
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);
            position: relative;
            overflow: hidden;
        }
        
        .btn-gradient::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, transparent, rgba(255,255,255,0.2), transparent);
            transform: translateX(-100%);
            transition: transform 0.6s;
        }
        
        .btn-gradient:hover::before {
            transform: translateX(100%);
        }
        
        .btn-gradient:hover {
            background-position: 100% 0;
            transform: translateY(-2px);
            box-shadow: 0 12px 32px rgba(102, 126, 234, 0.6);
        }
        
        .btn-gradient:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-outline {
            background: transparent;
            border: 2px solid #00f2fe;
            color: #00f2fe;
            font-weight: 600;
            padding: 18px 36px;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-outline:hover {
            background: #00f2fe;
            color: #0a0e1a;
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 242, 254, 0.4);
        }
        
        /* Input */
        input {
            background: rgba(255, 255, 255, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 16px;
            padding: 18px 24px;
            color: white;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            width: 100%;
        }
        
        input::placeholder {
            color: rgba(255, 255, 255, 0.6);
            font-weight: 400;
        }
        
        input:focus {
            outline: none;
            border-color: #00f2fe;
            background: rgba(255, 255, 255, 0.25);
            box-shadow: 0 0 20px rgba(0, 242, 254, 0.3);
        }
        
        input:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Text gradient */
        .text-gradient {
            background: linear-gradient(135deg, #00f2fe 0%, #4facfe 50%, #667eea 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* Progress bar */
        .progress-track {
            background: rgba(255, 255, 255, 0.1);
            height: 6px;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .progress-bar {
            background: linear-gradient(90deg, #667eea, #764ba2, #f093fb, #4facfe, #00f2fe);
            background-size: 200% 100%;
            height: 100%;
            border-radius: 10px;
            transition: width 0.5s ease;
            animation: shimmer 2s linear infinite;
        }
        
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        
        /* Glow effect */
        .glow {
            box-shadow: 0 0 40px rgba(0, 242, 254, 0.3);
        }
        
        /* Pulse animation */
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }
        
        .pulse {
            animation: pulse 2s ease-in-out infinite;
        }
        
        /* Float animation */
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        .float {
            animation: float 3s ease-in-out infinite;
        }
        
        /* Fade in */
        .fade-in {
            animation: fadeIn 0.6s ease-out;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Personality Icon - Responsive */
        .personality-icon {
            font-size: 4rem;
            line-height: 1;
            font-family: 'Apple Color Emoji', 'Segoe UI Emoji', 'Noto Color Emoji', sans-serif;
        }
        
        @media (min-width: 640px) {
            .personality-icon {
                font-size: 6rem;
            }
        }
        
        @media (min-width: 768px) {
            .personality-icon {
                font-size: 8rem;
            }
        }
        
        /* Badge */
        .badge {
            background: rgba(0, 242, 254, 0.2);
            border: 1px solid rgba(0, 242, 254, 0.4);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            background: #00f2fe;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        /* Stats card */
        .stat-card {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 24px;
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-4px);
            border-color: rgba(0, 242, 254, 0.5);
        }
        
        /* Timeframe toggle buttons */
        .timeframe-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.6);
        }
        
        .timeframe-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(0, 242, 254, 0.3);
            color: rgba(255, 255, 255, 0.9);
        }
        
        .timeframe-active {
            background: rgba(0, 242, 254, 0.2);
            border-color: rgb(0, 242, 254);
            color: rgb(0, 242, 254);
            font-weight: 700;
        }
    </style>
    
    <!-- CDN Fallback Detection -->
    <script>
        // Check if critical libraries loaded from CDN
        window.addEventListener('DOMContentLoaded', function() {
            setTimeout(function() {
                let missingLibraries = [];
                
                // Check if ethers.js loaded
                if (typeof ethers === 'undefined') {
                    missingLibraries.push('Ethers.js');
                }
                
                // Check if Chart.js loaded
                if (typeof Chart === 'undefined') {
                    missingLibraries.push('Chart.js');
                }
                
                // If any library failed to load, show user-friendly error
                if (missingLibraries.length > 0) {
                    const errorDiv = document.createElement('div');
                    errorDiv.style.cssText = `
                        position: fixed;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        background: rgba(239, 68, 68, 0.95);
                        color: white;
                        padding: 2rem;
                        border-radius: 1rem;
                        max-width: 90%;
                        text-align: center;
                        z-index: 9999;
                        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
                    `;
                    errorDiv.innerHTML = `
                        <h2 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 1rem;">‚ö†Ô∏è Loading Error</h2>
                        <p style="margin-bottom: 1rem;">Some required libraries failed to load from CDN:</p>
                        <p style="font-weight: bold; margin-bottom: 1rem;">${missingLibraries.join(', ')}</p>
                        <p style="font-size: 0.9rem; opacity: 0.9;">This could be due to:</p>
                        <ul style="text-align: left; margin: 1rem auto; max-width: 300px; font-size: 0.9rem;">
                            <li>‚Ä¢ Ad blocker blocking CDN</li>
                            <li>‚Ä¢ Slow internet connection</li>
                            <li>‚Ä¢ CDN temporarily down</li>
                        </ul>
                        <button onclick="location.reload()" style="
                            background: white;
                            color: #ef4444;
                            border: none;
                            padding: 0.75rem 1.5rem;
                            border-radius: 0.5rem;
                            font-weight: bold;
                            cursor: pointer;
                            margin-top: 1rem;
                        ">üîÑ Retry</button>
                    `;
                    document.body.appendChild(errorDiv);
                    
                    console.error('Failed to load libraries:', missingLibraries);
                }
            }, 2000); // Give CDN 2 seconds to load
        });
    </script>
</head>
<body class="bg-animated">
    
    <div class="min-h-screen p-4 md:p-8">
        <div class="max-w-6xl mx-auto">
            
            <!-- Start Screen -->
            <div id="startScreen" class="fade-in">
                
                <!-- Header - Interactive/Gamified -->
                <div class="text-center mb-12">
                    <!-- Current Plan Badge -->
                    <div class="flex justify-center mb-8 gap-3">
                        <div id="currentPlanBadge" class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-white/10 border border-white/20">
                            <span class="text-sm font-semibold">üÜì FREE PLAN</span>
                            <span class="text-xs text-white/60">|</span>
                            <span id="dailyUsage" class="text-xs text-white/60">0/3 today</span>
                        </div>
                        
                        <!-- Demo Plan Switcher -->
                        <button onclick="cyclePlan()" class="text-xs px-3 py-2 rounded-full bg-white/5 hover:bg-white/10 border border-white/20 transition">
                            Switch Plan (Demo)
                        </button>
                    </div>
                    
                    <!-- Animated Icon -->
                    <div class="text-8xl mb-6 float" style="margin-top: 1rem;">üß¨</div>
                    
                    <!-- Main Title -->
                    <h1 class="text-5xl sm:text-6xl md:text-7xl font-black mb-6 text-gradient px-4">
                        WALLET DNA
                    </h1>
                    
                    <!-- Interactive Question -->
                    <div class="glass p-6 sm:p-8 max-w-3xl mx-auto mb-8">
                        <p class="text-2xl sm:text-3xl md:text-4xl font-bold text-white mb-4">
                            Ready to decode your wallet? üîç
                        </p>
                        <p class="text-lg sm:text-xl text-white/80 mb-6">
                            Discover if you're a Diamond Hands üíé, Chart Master üìà, or something else entirely...
                        </p>
                        <div class="flex flex-wrap justify-center gap-3 text-sm sm:text-base">
                            <span class="px-4 py-2 rounded-full bg-white/10 text-white/70">
                                ‚ö° Takes 30 seconds
                            </span>
                            <span class="px-4 py-2 rounded-full bg-white/10 text-white/70">
                                üîí 100% anonymous
                            </span>
                            <span class="px-4 py-2 rounded-full bg-white/10 text-white/70">
                                üéØ 8 unique types
                            </span>
                        </div>
                    </div>
                    
                    <!-- CTA Arrow/Prompt -->
                    <div class="text-cyan-400 text-xl sm:text-2xl font-semibold mb-4 animate-bounce">
                        ‚Üì Start Here ‚Üì
                    </div>
                </div>
                
                <!-- Main Container -->
                <div class="glass p-8 md:p-12 mb-8">
                    
                    <h2 class="text-3xl font-bold mb-8 text-center">Choose Your Chain</h2>
                    
                    <!-- Chain Grid -->
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-6 mb-10">
                        
                        <div class="chain-btn" onclick="selectChain('bitcoin')">
                            <img src="https://cryptologos.cc/logos/bitcoin-btc-logo.svg" class="w-16 h-16 mx-auto mb-4">
                            <div class="text-lg font-bold text-center">Bitcoin</div>
                            <div class="text-sm text-white/60 text-center">BTC</div>
                        </div>
                        
                        <div class="chain-btn" onclick="selectChain('ethereum')">
                            <img src="https://cryptologos.cc/logos/ethereum-eth-logo.svg" class="w-16 h-16 mx-auto mb-4">
                            <div class="text-lg font-bold text-center">Ethereum</div>
                            <div class="text-sm text-white/60 text-center">ETH</div>
                        </div>
                        
                        <div class="chain-btn" onclick="selectChain('solana')">
                            <img src="https://cryptologos.cc/logos/solana-sol-logo.svg" class="w-16 h-16 mx-auto mb-4">
                            <div class="text-lg font-bold text-center">Solana</div>
                            <div class="text-sm text-white/60 text-center">SOL</div>
                        </div>
                        
                        <div class="chain-btn" onclick="selectChain('bsc')">
                            <div class="absolute top-2 right-2 bg-gradient-to-r from-cyan-500 to-purple-500 text-white text-xs px-2 py-1 rounded-full font-bold">
                                üîí PRO
                            </div>
                            <img src="https://cryptologos.cc/logos/bnb-bnb-logo.svg" class="w-16 h-16 mx-auto mb-4 opacity-60">
                            <div class="text-lg font-bold text-center">BNB Chain</div>
                            <div class="text-sm text-white/60 text-center">BNB</div>
                        </div>
                        
                        <div class="chain-btn" onclick="selectChain('polygon')">
                            <div class="absolute top-2 right-2 bg-gradient-to-r from-cyan-500 to-purple-500 text-white text-xs px-2 py-1 rounded-full font-bold">
                                üîí PRO
                            </div>
                            <img src="https://cryptologos.cc/logos/polygon-matic-logo.svg" class="w-16 h-16 mx-auto mb-4 opacity-60">
                            <div class="text-lg font-bold text-center">Polygon</div>
                            <div class="text-sm text-white/60 text-center">MATIC</div>
                        </div>
                        
                        <div class="chain-btn" onclick="selectChain('avalanche')">
                            <div class="absolute top-2 right-2 bg-gradient-to-r from-cyan-500 to-purple-500 text-white text-xs px-2 py-1 rounded-full font-bold">
                                üîí PRO
                            </div>
                            <img src="https://cryptologos.cc/logos/avalanche-avax-logo.svg" class="w-16 h-16 mx-auto mb-4 opacity-60">
                            <div class="text-lg font-bold text-center">Avalanche</div>
                            <div class="text-sm text-white/60 text-center">AVAX</div>
                        </div>
                        
                    </div>
                    
                    <!-- Selected Info -->
                    <div id="selectedChainInfo" class="hidden glass p-4 mb-8 text-center glow">
                        <span class="text-white/70">Selected: </span>
                        <span id="selectedChainName" class="font-bold text-gradient text-xl"></span>
                    </div>
                    
                    <!-- Actions -->
                    <div class="space-y-4">
                        
                        <button id="connectWalletBtn" onclick="connectWallet()" class="btn-gradient w-full text-lg" disabled>
                            üîó Connect Wallet
                        </button>
                        
                        <div class="flex items-center gap-4 my-6">
                            <div class="flex-1 h-px bg-white/20"></div>
                            <span class="text-white/50 text-sm font-semibold">OR ENTER ADDRESS</span>
                            <div class="flex-1 h-px bg-white/20"></div>
                        </div>
                        
                        <input 
                            type="text" 
                            id="manualAddress" 
                            placeholder="0x... or wallet address"
                            disabled
                        />
                        
                        <button id="analyzeAddressBtn" onclick="analyzeManualAddress()" class="btn-outline w-full text-lg" disabled>
                            üîç Analyze Address
                        </button>
                        
                        <div id="testAddressDiv" class="hidden text-center">
                            <button onclick="useTestAddress()" class="text-cyan-400 hover:text-cyan-300 font-semibold transition">
                                üé≤ Try Demo Wallet (5 wallets per chain - click to cycle)
                            </button>
                        </div>
                        
                    </div>
                    
                </div>
                
            </div>
            
            <!-- Loading Screen -->
            <div id="loadingScreen" class="hidden fade-in">
                <div class="glass p-12 text-center">
                    <div class="text-8xl mb-8 pulse">üîç</div>
                    <h2 class="text-4xl font-bold mb-4">Analyzing Your Wallet</h2>
                    <p class="text-xl text-white/70 mb-2" id="selectedChainDisplay"></p>
                    <p class="text-white/50 mb-10" id="loadingStatus">Initializing...</p>
                    
                    <div class="progress-track mb-10 max-w-md mx-auto">
                        <div id="loadingBar" class="progress-bar" style="width: 0%"></div>
                    </div>
                    
                    <div class="space-y-4 max-w-md mx-auto text-left">
                        <div id="step1" class="flex items-center text-white/40">
                            <span class="mr-4 text-xl">‚óã</span>
                            <span>Connecting to blockchain...</span>
                        </div>
                        <div id="step2" class="flex items-center text-white/40">
                            <span class="mr-4 text-xl">‚óã</span>
                            <span>Fetching transaction history...</span>
                        </div>
                        <div id="step3" class="flex items-center text-white/40">
                            <span class="mr-4 text-xl">‚óã</span>
                            <span>Analyzing patterns...</span>
                        </div>
                        <div id="step4" class="flex items-center text-white/40">
                            <span class="mr-4 text-xl">‚óã</span>
                            <span>Determining personality...</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Results Screen -->
            <div id="resultsScreen" class="hidden fade-in">
                <div class="glass p-8 md:p-12">
                    
                    <!-- Chain Info -->
                    <div class="text-center mb-8">
                        <div class="flex items-center justify-center gap-4 mb-2">
                            <div id="resultChainIcon" class="text-4xl"></div>
                            <h3 class="text-2xl font-bold">
                                <span id="resultChainName"></span> Analysis
                            </h3>
                        </div>
                    </div>
                    
                    <!-- Personality Header -->
                    <div class="text-center mb-12">
                        <div class="mb-6 personality-icon" id="personalityIcon"></div>
                        <h2 class="text-3xl sm:text-4xl md:text-5xl font-black mb-4 text-gradient px-4" id="personalityType"></h2>
                        <p class="text-lg sm:text-xl md:text-2xl text-white/80 px-4" id="personalityDesc"></p>
                    </div>
                    
                    <!-- Stats Grid -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-10">
                        <div class="stat-card">
                            <div class="text-xs sm:text-sm text-white/60 mb-2">TRANSACTIONS</div>
                            <div class="text-2xl sm:text-3xl md:text-4xl font-black text-gradient" id="statTxCount"></div>
                        </div>
                        <div class="stat-card">
                            <div class="text-xs sm:text-sm text-white/60 mb-2">WALLET AGE</div>
                            <div class="text-2xl sm:text-3xl md:text-4xl font-black text-gradient" id="statWalletAge"></div>
                        </div>
                        <div class="stat-card">
                            <div class="text-xs sm:text-sm text-white/60 mb-2">BALANCE</div>
                            <div class="text-2xl sm:text-3xl md:text-4xl font-black text-gradient" id="statBalance"></div>
                        </div>
                        <div class="stat-card">
                            <div class="text-xs sm:text-sm text-white/60 mb-2">ACTIVITY</div>
                            <div class="text-2xl sm:text-3xl md:text-4xl font-black text-gradient" id="statActivity"></div>
                        </div>
                    </div>
                    
                    <!-- Traits -->
                    <div class="glass p-4 sm:p-6 md:p-8 mb-6">
                        <h3 class="text-xl sm:text-2xl font-bold mb-6 flex items-center gap-3">
                            <span>‚ú®</span> Your Traits
                        </h3>
                        <ul id="traits" class="space-y-4 text-base sm:text-lg"></ul>
                    </div>
                    
                    <!-- Strengths -->
                    <div class="glass p-4 sm:p-6 md:p-8 mb-6" id="strengthsSection" style="display:none;">
                        <h3 class="text-xl sm:text-2xl font-bold mb-6 flex items-center gap-3">
                            <span>üí™</span> Your Strengths
                        </h3>
                        <ul id="strengths" class="space-y-3 text-base sm:text-lg text-white/90"></ul>
                    </div>
                    
                    <!-- Watch Outs -->
                    <div class="glass p-4 sm:p-6 md:p-8 mb-6" id="watchoutsSection" style="display:none;">
                        <h3 class="text-xl sm:text-2xl font-bold mb-6 flex items-center gap-3">
                            <span>‚ö†Ô∏è</span> Things to Watch Out For
                        </h3>
                        <ul id="watchouts" class="space-y-3 text-base sm:text-lg text-white/90"></ul>
                    </div>
                    
                    <!-- Advice (for newbies) -->
                    <div class="glass p-4 sm:p-6 md:p-8 mb-6" id="adviceSection" style="display:none;">
                        <h3 class="text-xl sm:text-2xl font-bold mb-6 flex items-center gap-3">
                            <span>üéì</span> Pro Tips for Your Journey
                        </h3>
                        <ul id="advice" class="space-y-3 text-base sm:text-lg text-white/90"></ul>
                    </div>
                    
                    <!-- Insights -->
                    <div class="glass p-4 sm:p-6 md:p-8 mb-6">
                        <h3 class="text-xl sm:text-2xl font-bold mb-6 flex items-center gap-3">
                            <span>üí°</span> Insights
                        </h3>
                        <div id="insights" class="space-y-4 text-base sm:text-lg text-white/80"></div>
                    </div>
                    
                    <!-- Chart -->
                    <div class="glass p-4 sm:p-6 md:p-8 mb-8">
                        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-6 gap-4">
                            <h3 class="text-xl sm:text-2xl font-bold flex items-center gap-3">
                                <span>üìä</span> Balance History
                            </h3>
                            <div class="flex flex-wrap gap-2">
                                <button onclick="changeTimeframe('daily')" id="btn-daily" class="timeframe-btn px-3 sm:px-4 py-2 rounded-lg text-xs sm:text-sm font-semibold transition">
                                    Daily
                                </button>
                                <button onclick="changeTimeframe('weekly')" id="btn-weekly" class="timeframe-btn px-3 sm:px-4 py-2 rounded-lg text-xs sm:text-sm font-semibold transition">
                                    Weekly
                                </button>
                                <button onclick="changeTimeframe('biweekly')" id="btn-biweekly" class="timeframe-btn timeframe-active px-3 sm:px-4 py-2 rounded-lg text-xs sm:text-sm font-semibold transition">
                                    Biweekly
                                </button>
                                <button onclick="changeTimeframe('monthly')" id="btn-monthly" class="timeframe-btn px-3 sm:px-4 py-2 rounded-lg text-xs sm:text-sm font-semibold transition">
                                    Monthly
                                </button>
                            </div>
                        </div>
                        <div class="w-full overflow-x-auto">
                            <canvas id="portfolioChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- PREMIUM FEATURES START -->
                    
                    <!-- Wallet Health Score (Premium+) -->
                    <div id="walletHealthSection" class="glass p-4 sm:p-6 md:p-8 mb-8 relative" style="display:none;">
                        <div class="text-center mb-6">
                            <h3 class="text-xl sm:text-2xl font-bold mb-4 flex items-center justify-center gap-3">
                                <span>‚ù§Ô∏è</span> Wallet Health Score
                            </h3>
                            
                            <!-- Health Score Circle -->
                            <div class="relative inline-flex items-center justify-center w-32 h-32 mb-4">
                                <svg class="w-full h-full transform -rotate-90">
                                    <circle cx="64" cy="64" r="56" stroke="rgba(255,255,255,0.1)" stroke-width="8" fill="none"/>
                                    <circle id="healthCircle" cx="64" cy="64" r="56" stroke="url(#healthGradient)" stroke-width="8" fill="none" 
                                            stroke-dasharray="352" stroke-dashoffset="88" stroke-linecap="round"/>
                                    <defs>
                                        <linearGradient id="healthGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                            <stop offset="0%" style="stop-color:#00f2fe"/>
                                            <stop offset="100%" style="stop-color:#4facfe"/>
                                        </linearGradient>
                                    </defs>
                                </svg>
                                <div class="absolute inset-0 flex flex-col items-center justify-center">
                                    <span id="healthScore" class="text-4xl font-black text-gradient">87</span>
                                    <span class="text-xs text-white/60">/ 100</span>
                                </div>
                            </div>
                            
                            <!-- Health Breakdown -->
                            <div class="space-y-3 text-left max-w-md mx-auto">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-white/80">Security</span>
                                    <div class="flex items-center gap-2">
                                        <div class="w-32 h-2 bg-white/10 rounded-full overflow-hidden">
                                            <div class="h-full bg-gradient-to-r from-cyan-400 to-blue-400" style="width: 82%"></div>
                                        </div>
                                        <span class="text-sm font-bold text-cyan-400 w-8">82</span>
                                    </div>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-white/80">Activity</span>
                                    <div class="flex items-center gap-2">
                                        <div class="w-32 h-2 bg-white/10 rounded-full overflow-hidden">
                                            <div class="h-full bg-gradient-to-r from-green-400 to-emerald-400" style="width: 91%"></div>
                                        </div>
                                        <span class="text-sm font-bold text-green-400 w-8">91</span>
                                    </div>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-white/80">Diversification</span>
                                    <div class="flex items-center gap-2">
                                        <div class="w-32 h-2 bg-white/10 rounded-full overflow-hidden">
                                            <div class="h-full bg-gradient-to-r from-yellow-400 to-orange-400" style="width: 65%"></div>
                                        </div>
                                        <span class="text-sm font-bold text-yellow-400 w-8">65</span>
                                    </div>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-white/80">Gas Efficiency</span>
                                    <div class="flex items-center gap-2">
                                        <div class="w-32 h-2 bg-white/10 rounded-full overflow-hidden">
                                            <div class="h-full bg-gradient-to-r from-cyan-400 to-blue-400" style="width: 79%"></div>
                                        </div>
                                        <span class="text-sm font-bold text-cyan-400 w-8">79</span>
                                    </div>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-white/80">Risk Level</span>
                                    <div class="flex items-center gap-2">
                                        <div class="w-32 h-2 bg-white/10 rounded-full overflow-hidden">
                                            <div class="h-full bg-gradient-to-r from-red-400 to-pink-400" style="width: 34%"></div>
                                        </div>
                                        <span class="text-sm font-bold text-green-400 w-8">34</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Portfolio Breakdown (Premium+) -->
                    <div id="portfolioBreakdownSection" class="glass p-4 sm:p-6 md:p-8 mb-8" style="display:none;">
                        <h3 class="text-xl sm:text-2xl font-bold mb-6 flex items-center gap-3">
                            <span>üí∞</span> Portfolio Breakdown
                        </h3>
                        <div class="space-y-3">
                            <div class="flex items-center justify-between p-3 bg-white/5 rounded-lg">
                                <div class="flex items-center gap-3">
                                    <span class="text-2xl">1.</span>
                                    <div>
                                        <div class="font-bold">ETH</div>
                                        <div class="text-xs text-white/50">Ethereum</div>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="font-bold">45.2%</div>
                                    <div class="text-sm text-green-400">+5.2%</div>
                                </div>
                            </div>
                            <div class="flex items-center justify-between p-3 bg-white/5 rounded-lg">
                                <div class="flex items-center gap-3">
                                    <span class="text-2xl">2.</span>
                                    <div>
                                        <div class="font-bold">USDC</div>
                                        <div class="text-xs text-white/50">Stablecoin</div>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="font-bold">28.1%</div>
                                    <div class="text-sm text-white/50">0.0%</div>
                                </div>
                            </div>
                            <div class="flex items-center justify-between p-3 bg-white/5 rounded-lg">
                                <div class="flex items-center gap-3">
                                    <span class="text-2xl">3.</span>
                                    <div>
                                        <div class="font-bold">LINK</div>
                                        <div class="text-xs text-white/50">Chainlink</div>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="font-bold">12.3%</div>
                                    <div class="text-sm text-green-400">+12.1%</div>
                                </div>
                            </div>
                        </div>
                        <div class="mt-4 p-4 bg-cyan-400/10 border border-cyan-400/30 rounded-lg">
                            <p class="text-sm text-white/80">
                                üí° <strong>Insight:</strong> You're 73% in stablecoins + ETH (conservative). Consider rebalancing - high ETH concentration detected.
                            </p>
                        </div>
                    </div>
                    
                    <!-- Transaction Patterns (Premium+) -->
                    <div id="transactionPatternsSection" class="glass p-4 sm:p-6 md:p-8 mb-8" style="display:none;">
                        <h3 class="text-xl sm:text-2xl font-bold mb-6 flex items-center gap-3">
                            <span>üìà</span> Transaction Patterns
                        </h3>
                        <div class="grid sm:grid-cols-2 gap-4">
                            <div class="p-4 bg-white/5 rounded-lg">
                                <div class="text-sm text-white/60 mb-1">Most Active Hour</div>
                                <div class="text-2xl font-bold text-cyan-400">2-3 PM EST</div>
                            </div>
                            <div class="p-4 bg-white/5 rounded-lg">
                                <div class="text-sm text-white/60 mb-1">Most Active Day</div>
                                <div class="text-2xl font-bold text-purple-400">Wednesday</div>
                            </div>
                            <div class="p-4 bg-white/5 rounded-lg">
                                <div class="text-sm text-white/60 mb-1">Avg Gas Paid</div>
                                <div class="text-2xl font-bold text-white">$12.50</div>
                            </div>
                            <div class="p-4 bg-white/5 rounded-lg">
                                <div class="text-sm text-white/60 mb-1">Gas Saved (if optimal)</div>
                                <div class="text-2xl font-bold text-green-400">$450</div>
                                <div class="text-xs text-white/50">23% savings possible</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Upgrade Prompt (for Free users) -->
                    <div id="upgradePromptSection" class="relative mb-8" style="display:none;">
                        <div class="absolute inset-0 bg-gradient-to-r from-cyan-500/20 via-purple-500/20 to-pink-500/20 blur-2xl"></div>
                        <div class="glass p-6 sm:p-8 border-2 border-cyan-400/50 relative">
                            <div class="text-center">
                                <div class="text-6xl mb-4">üöÄ</div>
                                <h3 class="text-2xl sm:text-3xl font-black mb-3 text-gradient">
                                    Unlock Premium Features
                                </h3>
                                <p class="text-white/80 mb-6">
                                    Get deeper insights, advanced analytics, and unlimited analyses
                                </p>
                                
                                <!-- Pricing Cards -->
                                <div class="grid md:grid-cols-2 gap-4 mb-6">
                                    <!-- Premium -->
                                    <div class="glass p-6 border border-cyan-400/30 rounded-2xl text-left">
                                        <div class="text-cyan-400 font-bold text-sm mb-2">PREMIUM</div>
                                        <div class="text-4xl font-black mb-4">
                                            $9.99<span class="text-lg text-white/50">/mo</span>
                                        </div>
                                        <ul class="space-y-2 text-sm mb-6">
                                            <li class="flex items-start gap-2">
                                                <span class="text-green-400">‚úì</span>
                                                <span>Unlimited analyses</span>
                                            </li>
                                            <li class="flex items-start gap-2">
                                                <span class="text-green-400">‚úì</span>
                                                <span>All 6 chains</span>
                                            </li>
                                            <li class="flex items-start gap-2">
                                                <span class="text-green-400">‚úì</span>
                                                <span>Wallet Health Score</span>
                                            </li>
                                            <li class="flex items-start gap-2">
                                                <span class="text-green-400">‚úì</span>
                                                <span>Portfolio Breakdown</span>
                                            </li>
                                            <li class="flex items-start gap-2">
                                                <span class="text-green-400">‚úì</span>
                                                <span>Multi-wallet comparison</span>
                                            </li>
                                        </ul>
                                        <button onclick="upgradeToPremium()" class="btn-gradient w-full py-3">
                                            Upgrade to Premium
                                        </button>
                                    </div>
                                    
                                    <!-- Pro -->
                                    <div class="relative">
                                        <div class="absolute -top-3 left-1/2 transform -translate-x-1/2 bg-gradient-to-r from-purple-500 to-pink-500 px-4 py-1 rounded-full text-xs font-bold z-10">
                                            MOST POPULAR
                                        </div>
                                        <div class="glass p-6 border-2 border-purple-400/50 rounded-2xl text-left relative z-0">
                                            <div class="text-purple-400 font-bold text-sm mb-2">PRO</div>
                                            <div class="text-4xl font-black mb-4">
                                                $29.99<span class="text-lg text-white/50">/mo</span>
                                            </div>
                                            <ul class="space-y-2 text-sm mb-6">
                                                <li class="flex items-start gap-2">
                                                    <span class="text-green-400">‚úì</span>
                                                    <span>Everything in Premium</span>
                                                </li>
                                                <li class="flex items-start gap-2">
                                                    <span class="text-green-400">‚úì</span>
                                                    <span>AI-Powered Insights</span>
                                                </li>
                                                <li class="flex items-start gap-2">
                                                    <span class="text-green-400">‚úì</span>
                                                    <span>Whale Watching</span>
                                                </li>
                                                <li class="flex items-start gap-2">
                                                    <span class="text-green-400">‚úì</span>
                                                    <span>API Access</span>
                                                </li>
                                                <li class="flex items-start gap-2">
                                                    <span class="text-green-400">‚úì</span>
                                                    <span>Priority Support</span>
                                                </li>
                                            </ul>
                                            <button onclick="upgradeToPro()" class="w-full py-3 rounded-xl font-bold bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 transition">
                                                Upgrade to Pro
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- PREMIUM FEATURES END -->
                    
                    <!-- Wallet Address -->
                    <div class="text-center text-sm text-white/50 mb-8 font-mono">
                        <span id="walletAddress"></span>
                    </div>
                    
                    <!-- NFT Personality Certificate - TRENDY VERSION -->
                    <div class="relative mb-8">
                        <!-- Glow background effect -->
                        <div class="absolute inset-0 bg-gradient-to-r from-cyan-500/20 via-purple-500/20 to-pink-500/20 blur-3xl"></div>
                        
                        <div class="glass p-6 sm:p-8 border-2 border-cyan-400/50 relative overflow-hidden">
                            <!-- Animated background pattern -->
                            <div class="absolute inset-0 opacity-10">
                                <div class="absolute inset-0 bg-gradient-to-br from-cyan-400 via-purple-400 to-pink-400 animate-pulse"></div>
                            </div>
                            
                            <div class="relative z-10">
                                <!-- Header -->
                                <div class="text-center mb-8">
                                    <div class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-gradient-to-r from-cyan-500/20 to-purple-500/20 border border-cyan-400/30 mb-4">
                                        <span class="w-2 h-2 rounded-full bg-cyan-400 animate-pulse"></span>
                                        <span class="text-sm font-bold text-cyan-400">LIMITED DROP</span>
                                    </div>
                                    <h3 class="text-3xl sm:text-4xl font-black mb-3 bg-gradient-to-r from-cyan-400 via-purple-400 to-pink-400 bg-clip-text text-transparent">
                                        MINT YOUR DNA
                                    </h3>
                                    <p class="text-base sm:text-lg text-white/80">
                                        Turn your wallet personality into a collectible NFT
                                    </p>
                                </div>
                                
                                <!-- NFT Card - Modern 3D Style -->
                                <div class="max-w-sm mx-auto mb-8">
                                    <div class="relative group">
                                        <!-- Card glow on hover -->
                                        <div class="absolute -inset-1 bg-gradient-to-r from-cyan-400 via-purple-400 to-pink-400 rounded-3xl blur opacity-25 group-hover:opacity-75 transition duration-1000"></div>
                                        
                                        <!-- Main card -->
                                        <div class="relative bg-gradient-to-br from-gray-900 to-black rounded-3xl p-6 border border-cyan-400/30">
                                            <!-- Top bar with edition number -->
                                            <div class="flex justify-between items-center mb-4">
                                                <span class="text-xs font-mono text-cyan-400">WALLET DNA</span>
                                                <span class="text-xs font-mono text-white/50">#<span id="nftEditionNumber">001</span></span>
                                            </div>
                                            
                                            <!-- Large centered icon with glow -->
                                            <div class="text-center mb-4">
                                                <div class="relative inline-block">
                                                    <div class="absolute inset-0 blur-2xl opacity-50 bg-gradient-to-br from-cyan-400 to-purple-400"></div>
                                                    <div class="relative text-8xl" id="nftPreviewIcon">üíé</div>
                                                </div>
                                            </div>
                                            
                                            <!-- Personality name with gradient -->
                                            <h4 class="text-2xl font-black text-center mb-2 bg-gradient-to-r from-white to-white/70 bg-clip-text text-transparent" id="nftPreviewType">
                                                The Diamond Hands
                                            </h4>
                                            
                                            <!-- Chain badge -->
                                            <div class="text-center mb-6">
                                                <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-cyan-400/10 border border-cyan-400/30 text-xs font-semibold text-cyan-400">
                                                    <span id="nftPreviewChain">Ethereum</span>
                                                </span>
                                            </div>
                                            
                                            <!-- Stats grid -->
                                            <div class="grid grid-cols-3 gap-3 mb-4">
                                                <div class="bg-gradient-to-br from-white/5 to-white/0 rounded-xl p-3 border border-white/10 text-center">
                                                    <div class="text-xs text-white/50 mb-1">TXs</div>
                                                    <div class="text-sm font-bold text-cyan-400" id="nftPreviewTx">1.2K</div>
                                                </div>
                                                <div class="bg-gradient-to-br from-white/5 to-white/0 rounded-xl p-3 border border-white/10 text-center">
                                                    <div class="text-xs text-white/50 mb-1">Age</div>
                                                    <div class="text-sm font-bold text-purple-400" id="nftPreviewAge">365d</div>
                                                </div>
                                                <div class="bg-gradient-to-br from-white/5 to-white/0 rounded-xl p-3 border border-white/10 text-center">
                                                    <div class="text-xs text-white/50 mb-1">Rarity</div>
                                                    <div class="text-sm font-bold text-pink-400">Epic</div>
                                                </div>
                                            </div>
                                            
                                            <!-- Bottom certification -->
                                            <div class="pt-4 border-t border-white/10 flex items-center justify-between">
                                                <div class="text-xs text-white/40 font-mono">CERTIFIED</div>
                                                <div class="flex items-center gap-1">
                                                    <div class="w-1.5 h-1.5 rounded-full bg-green-400"></div>
                                                    <span class="text-xs text-green-400">Authentic</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Features -->
                                <div class="grid grid-cols-3 gap-4 mb-8">
                                    <div class="text-center">
                                        <div class="w-12 h-12 mx-auto mb-2 rounded-2xl bg-gradient-to-br from-cyan-500/20 to-cyan-500/5 border border-cyan-400/30 flex items-center justify-center text-2xl">
                                            üé®
                                        </div>
                                        <div class="text-sm font-semibold text-white/90">Unique Art</div>
                                        <div class="text-xs text-white/50">AI Generated</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="w-12 h-12 mx-auto mb-2 rounded-2xl bg-gradient-to-br from-purple-500/20 to-purple-500/5 border border-purple-400/30 flex items-center justify-center text-2xl">
                                            ‚ôæÔ∏è
                                        </div>
                                        <div class="text-sm font-semibold text-white/90">Forever</div>
                                        <div class="text-xs text-white/50">On Solana</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="w-12 h-12 mx-auto mb-2 rounded-2xl bg-gradient-to-br from-pink-500/20 to-pink-500/5 border border-pink-400/30 flex items-center justify-center text-2xl">
                                            üî•
                                        </div>
                                        <div class="text-sm font-semibold text-white/90">Flex It</div>
                                        <div class="text-xs text-white/50">Social Ready</div>
                                    </div>
                                </div>
                                
                                <!-- Pricing -->
                                <div class="text-center mb-6">
                                    <div class="inline-flex items-baseline gap-2">
                                        <span class="text-5xl font-black bg-gradient-to-r from-cyan-400 to-purple-400 bg-clip-text text-transparent">$19.99</span>
                                        <span class="text-white/60">USD</span>
                                    </div>
                                    <div class="text-sm text-white/50 mt-1">
                                        Pay with card or crypto ‚Ä¢ Instant mint
                                    </div>
                                </div>
                                
                                <!-- CTA Button - Super trendy -->
                                <button onclick="mintNFT()" class="group relative w-full sm:w-auto sm:px-16 py-5 rounded-2xl overflow-hidden">
                                    <!-- Animated gradient background -->
                                    <div class="absolute inset-0 bg-gradient-to-r from-cyan-500 via-purple-500 to-pink-500 transition-transform group-hover:scale-105"></div>
                                    <div class="absolute inset-0 bg-gradient-to-r from-cyan-400 via-purple-400 to-pink-400 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                                    
                                    <!-- Shine effect -->
                                    <div class="absolute inset-0 -translate-x-full group-hover:translate-x-full transition-transform duration-1000 bg-gradient-to-r from-transparent via-white/30 to-transparent"></div>
                                    
                                    <!-- Button content -->
                                    <span class="relative flex items-center justify-center gap-2 text-lg font-black text-white">
                                        <span>MINT NOW</span>
                                        <span class="text-2xl">üöÄ</span>
                                    </span>
                                </button>
                                
                                <!-- Trust signals -->
                                <div class="flex flex-wrap justify-center gap-3 mt-6 text-xs text-white/50">
                                    <span class="flex items-center gap-1">
                                        <span class="text-green-400">‚úì</span> Solana Network
                                    </span>
                                    <span class="flex items-center gap-1">
                                        <span class="text-green-400">‚úì</span> Ultra-Low Fees
                                    </span>
                                    <span class="flex items-center gap-1">
                                        <span class="text-green-400">‚úì</span> Instant Delivery
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="grid md:grid-cols-2 gap-4">
                        <button onclick="shareResults()" class="btn-gradient text-lg">
                            üì§ Share Results
                        </button>
                        <button onclick="restartTest()" class="btn-outline text-lg">
                            üîÑ Test Another Wallet
                        </button>
                    </div>
                    
                </div>
            </div>
            
            <!-- Error Screen -->
            <div id="errorScreen" class="hidden fade-in">
                <div class="glass p-12 text-center">
                    <div class="text-8xl mb-8">‚ö†Ô∏è</div>
                    <h2 class="text-4xl font-bold mb-6">Oops!</h2>
                    <p class="text-xl text-white/70 mb-10" id="errorMessage"></p>
                    <button onclick="restartTest()" class="btn-gradient text-lg">
                        Try Again
                    </button>
                </div>
            </div>
            
        </div>
    </div>

    <script>        // ==================== CONFIGURATION ====================
        
        // API Keys are hardcoded and ready to use!
        // ==================== SECURE API CONFIGURATION ====================
        // API keys are now stored securely on the backend server
        // Frontend calls the backend proxy instead of blockchain APIs directly
        
        const API_CONFIG = {
            // Backend API proxy server
            backend: 'http://localhost:3001',
            
            // For production deployment, replace with your actual backend URL:
            // backend: 'https://api.wallet-dna.com',
        };
        
        // Check backend connection on page load
        async function checkBackendConnection() {
            try {
                const response = await fetch(`${API_CONFIG.backend}/health`, {
                    method: 'GET',
                    mode: 'cors'
                });
                
                if (response.ok) {
                    console.log('‚úÖ Backend server connected successfully');
                    return true;
                }
            } catch (error) {
                console.error('‚ùå Backend server not reachable:', error);
                
                // Show user-friendly error
                const errorDiv = document.createElement('div');
                errorDiv.style.cssText = `
                    position: fixed;
                    top: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: rgba(239, 68, 68, 0.95);
                    color: white;
                    padding: 1.5rem;
                    border-radius: 1rem;
                    max-width: 500px;
                    text-align: center;
                    z-index: 9999;
                    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
                `;
                errorDiv.innerHTML = `
                    <h3 style="font-size: 1.25rem; font-weight: bold; margin-bottom: 0.5rem;">‚ö†Ô∏è Backend Server Not Running</h3>
                    <p style="margin-bottom: 1rem; font-size: 0.9rem;">
                        The API proxy server is not running. Please start it with:
                    </p>
                    <code style="background: rgba(0,0,0,0.3); padding: 0.5rem; border-radius: 0.5rem; display: block; font-family: monospace; margin-bottom: 1rem;">
                        node backend-server.js
                    </code>
                    <button onclick="this.parentElement.remove()" style="
                        background: white;
                        color: #ef4444;
                        border: none;
                        padding: 0.5rem 1rem;
                        border-radius: 0.5rem;
                        font-weight: bold;
                        cursor: pointer;
                    ">Dismiss</button>
                `;
                document.body.appendChild(errorDiv);
                return false;
            }
        }
        
        // Check connection when page loads
        window.addEventListener('DOMContentLoaded', checkBackendConnection);

        // ==================== PRICING PLANS ====================
        
        // HTML Escaping utility for security (prevents XSS)
        function escapeHTML(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }
        
        // Validate wallet address format
        function isValidAddress(address, chain) {
            if (!address || typeof address !== 'string') return false;
            
            // Remove whitespace
            address = address.trim();
            
            switch(chain) {
                case 'ethereum':
                case 'polygon':
                case 'bsc':
                case 'avalanche':
                    // Ethereum-style: 0x followed by 40 hex characters
                    return /^0x[a-fA-F0-9]{40}$/.test(address);
                    
                case 'bitcoin':
                    // Bitcoin: Various formats (legacy, segwit, bech32)
                    return /^(1|3|bc1)[a-zA-HJ-NP-Z0-9]{25,62}$/.test(address);
                    
                case 'solana':
                    // Solana: Base58, typically 32-44 characters
                    return /^[1-9A-HJ-NP-Za-km-z]{32,44}$/.test(address);
                    
                default:
                    return false;
            }
        }
        
        const PLANS = {
            free: {
                name: 'Free',
                price: 0,
                features: {
                    analysesPerDay: 3,
                    chains: ['ethereum', 'bitcoin', 'solana'],
                    walletHealthScore: false,
                    portfolioBreakdown: false,
                    transactionPatterns: false,
                    smartContractSafety: false,
                    multiWallet: false,
                    taxExport: false,
                    evolutionTracker: false,
                    alerts: 0,
                    whaleWatching: false,
                    aiInsights: false,
                    peerBenchmark: false,
                    advancedCharts: false,
                    apiAccess: false
                }
            },
            premium: {
                name: 'Premium',
                price: 9.99,
                features: {
                    analysesPerDay: -1, // unlimited
                    chains: ['ethereum', 'bitcoin', 'solana', 'polygon', 'bsc', 'avalanche'],
                    walletHealthScore: true,
                    portfolioBreakdown: true,
                    transactionPatterns: true,
                    smartContractSafety: true,
                    multiWallet: 3,
                    taxExport: 'basic',
                    evolutionTracker: true,
                    alerts: 5,
                    whaleWatching: false,
                    aiInsights: false,
                    peerBenchmark: false,
                    advancedCharts: false,
                    apiAccess: false
                }
            },
            pro: {
                name: 'Pro',
                price: 29.99,
                features: {
                    analysesPerDay: -1,
                    chains: ['ethereum', 'bitcoin', 'solana', 'polygon', 'bsc', 'avalanche'],
                    walletHealthScore: true,
                    portfolioBreakdown: true,
                    transactionPatterns: true,
                    smartContractSafety: true,
                    multiWallet: -1,
                    taxExport: 'advanced',
                    evolutionTracker: true,
                    alerts: -1,
                    whaleWatching: 10,
                    aiInsights: true,
                    peerBenchmark: true,
                    advancedCharts: true,
                    apiAccess: true
                }
            }
        };
        
        let currentPlan = 'free';
        let analysesUsedToday = 0;
        let lastAnalysisDate = new Date().toDateString();
        
        function hasAccess(feature) {
            return PLANS[currentPlan].features[feature];
        }
        
        function isChainAvailable(chain) {
            return PLANS[currentPlan].features.chains.includes(chain);
        }
        
        function canAnalyzeToday() {
            const today = new Date().toDateString();
            if (today !== lastAnalysisDate) {
                analysesUsedToday = 0;
                lastAnalysisDate = today;
            }
            const limit = PLANS[currentPlan].features.analysesPerDay;
            return limit === -1 || analysesUsedToday < limit;
        }
        
        // ==================== CHAINS ====================
        
        const chains = {
            ethereum: {
                name: 'Ethereum',
                icon: '‚ü†',
                nativeCurrency: 'ETH',
                explorer: 'etherscan.io'
            },
            bitcoin: {
                name: 'Bitcoin',
                icon: '‚Çø',
                nativeCurrency: 'BTC',
                explorer: 'blockchain.info'
            },
            solana: {
                name: 'Solana',
                icon: 'SOL',
                nativeCurrency: 'SOL',
                explorer: 'solscan.io'
            },
            bsc: {
                name: 'BNB Chain',
                icon: 'BNB',
                nativeCurrency: 'BNB',
                explorer: 'bscscan.com'
            },
            polygon: {
                name: 'Polygon',
                icon: 'MATIC',
                nativeCurrency: 'MATIC',
                explorer: 'polygonscan.com'
            },
            avalanche: {
                name: 'Avalanche',
                icon: 'AVAX',
                nativeCurrency: 'AVAX',
                explorer: 'snowtrace.io'
            }
        };

        const personalities = {
            hodler: {
                name: 'The Diamond Hands',
                icon: 'üíé',
                desc: 'You\'re a true believer in the long game. Market dips don\'t shake you‚Äîthey energize you. While others panic sell, you\'re accumulating. Your conviction is unshakeable, and your patience is legendary.',
                traits: [
                    'Strong conviction - you don\'t waver during market volatility',
                    'Strategic accumulator - you buy dips and rarely sell',
                    'Long-term vision - thinking in years, not days',
                    'Emotional discipline - fear and greed don\'t control you',
                    'Research-driven - you invest based on fundamentals',
                    'Portfolio stability - low turnover, high conviction',
                    'Delayed gratification - willing to wait for real gains'
                ],
                strengths: [
                    'Exceptional patience and emotional control',
                    'Strong resistance to FOMO and panic',
                    'Deep understanding of long-term value',
                    'Compound growth mindset'
                ],
                watchouts: [
                    'May miss short-term opportunities',
                    'Could be slow to adapt to changing market conditions',
                    'Might hold losing positions too long',
                    'Portfolio may lack diversification'
                ]
            },
            daytrader: {
                name: 'The Chart Master',
                icon: 'üìà',
                desc: 'You live for the thrill of the trade. Charts, indicators, and order books are your playground. Quick reflexes, sharp instincts, and an appetite for action define your approach. You don\'t just watch the market‚Äîyou dance with it.',
                traits: [
                    'Hyper-active trading - multiple transactions daily',
                    'Technical analysis expert - you read charts like poetry',
                    'Quick decision maker - can pivot in seconds',
                    'Risk-comfortable - volatility is opportunity',
                    'Information junkie - always seeking the next edge',
                    'Adaptable strategy - you adjust to market conditions',
                    'Performance tracking - you know your win rate cold'
                ],
                strengths: [
                    'Excellent market timing and execution',
                    'Ability to profit in any market condition',
                    'Strong risk management skills',
                    'Quick to cut losses and take profits'
                ],
                watchouts: [
                    'High transaction fees can eat into profits',
                    'Burnout from constant monitoring',
                    'Overtrading during low-volatility periods',
                    'Tax complexity from numerous transactions'
                ]
            },
            degen: {
                name: 'The Degen Ape',
                icon: 'üé∞',
                desc: 'You\'re first to everything‚Äînew tokens, experimental protocols, community mints. "DYOR" to you means diving in headfirst and learning by doing. Your risk tolerance? Legendary. Your stories? Unforgettable. You turn the crypto casino into your playground.',
                traits: [
                    'Fearless explorer - you try everything first',
                    'Community-driven - you ape into group calls',
                    'High-risk tolerance - "Nothing ventured, nothing gained"',
                    'Early adopter - you find gems before they moon',
                    'Experimental mindset - failures are just lessons',
                    'Social trader - Discord and Twitter are your research',
                    'Narrative chaser - you ride the hype cycles'
                ],
                strengths: [
                    'Potential for massive asymmetric gains',
                    'Deep involvement in crypto culture',
                    'First-mover advantage on trends',
                    'Strong community connections'
                ],
                watchouts: [
                    'High loss rate - many experiments fail',
                    'Scam vulnerability - not everything is legit',
                    'Emotional rollercoaster - huge swings',
                    'Portfolio concentration in high-risk assets'
                ]
            },
            cautious: {
                name: 'The Careful Strategist',
                icon: 'üõ°Ô∏è',
                desc: 'You measure twice and cut once. Every move is calculated, every risk assessed. Security, stability, and sustainability matter more than quick gains. Your portfolio is a fortress, not a casino. Slow and steady isn\'t boring‚Äîit\'s intelligent.',
                traits: [
                    'Risk-averse approach - preservation over speculation',
                    'Thorough research - you read the documentation',
                    'Security-conscious - hardware wallets and best practices',
                    'Established projects only - blue chips over moonshots',
                    'Diversification focus - don\'t put all eggs in one basket',
                    'Long verification times - you triple-check addresses',
                    'Emergency fund mindset - always keep reserves'
                ],
                strengths: [
                    'Low risk of catastrophic losses',
                    'Strong security practices',
                    'Sustainable growth trajectory',
                    'Peace of mind and low stress'
                ],
                watchouts: [
                    'May miss high-growth opportunities',
                    'Analysis paralysis can delay decisions',
                    'Conservative approach may underperform in bull markets',
                    'Fear might prevent necessary portfolio adjustments'
                ]
            },
            whale: {
                name: 'The Whale',
                icon: 'üêã',
                desc: 'Your positions move markets. When you buy, others notice. When you sell, it makes waves. You\'ve either built massive wealth through crypto or brought it from traditional markets. Your decisions carry weight, and you know it. Power and responsibility go hand in hand.',
                traits: [
                    'Substantial capital - six figures or more deployed',
                    'Market impact - your trades create visible movement',
                    'Strategic positioning - you think about liquidity',
                    'Long-term wealth preservation - protecting what you\'ve built',
                    'Sophisticated strategies - you use advanced DeFi',
                    'Network effects - people watch your wallet',
                    'Institutional mindset - you think like a fund'
                ],
                strengths: [
                    'Access to exclusive opportunities',
                    'Ability to negotiate better terms',
                    'Strong network and insider access',
                    'Resources for professional advice'
                ],
                watchouts: [
                    'Target for scammers and hackers',
                    'Slippage on large trades',
                    'Regulatory scrutiny and reporting requirements',
                    'Difficulty exiting positions without affecting price'
                ]
            },
            defi: {
                name: 'The DeFi Degen',
                icon: '‚ö°',
                desc: 'Banks are obsolete to you. You are your own financial institution. Lending, borrowing, yield farming, liquidity providing‚Äîyou master it all. Smart contracts are your tools, and protocols are your playground. TradFi? Never heard of it.',
                traits: [
                    'Protocol power user - you interact with 10+ platforms',
                    'Yield optimizer - constantly seeking better APY',
                    'Gas fee calculator - you know when to transact',
                    'Smart contract reader - you audit code before deploying',
                    'Liquidity provider - you earn fees from trading pairs',
                    'Multi-chain operator - you bridge between networks',
                    'Token economics expert - you understand incentive models'
                ],
                strengths: [
                    'Passive income generation from multiple sources',
                    'Deep understanding of crypto mechanics',
                    'Early access to protocol incentives',
                    'Ability to leverage positions efficiently'
                ],
                watchouts: [
                    'Smart contract risk - code vulnerabilities',
                    'Impermanent loss from liquidity providing',
                    'Complex tax situations',
                    'Protocol risk - exploits and rug pulls'
                ]
            },
            nftcollector: {
                name: 'The NFT Connoisseur',
                icon: 'üé®',
                desc: 'You see what others miss‚Äîthe art, the culture, the community, the potential. Your collection tells a story. You don\'t just buy JPEGs; you curate experiences, support artists, and build digital legacy. Web3 culture flows through your veins.',
                traits: [
                    'Community participant - active in Discord and Twitter',
                    'Artistic eye - you appreciate quality and creativity',
                    'Culture curator - you spot trends before they peak',
                    'Relationship builder - you know the artists and founders',
                    'Whitelist hunter - you get early access to mints',
                    'Metadata analyst - you understand rarity and traits',
                    'Long-term collector - some pieces are never for sale'
                ],
                strengths: [
                    'Strong community connections',
                    'Cultural influence and tastemaking',
                    'Potential for significant appreciation',
                    'Digital identity and social capital'
                ],
                watchouts: [
                    'Liquidity challenges - hard to sell quickly',
                    'Market volatility - floor prices fluctuate',
                    'Emotional attachment may cloud judgment',
                    'Storage and display considerations'
                ]
            },
            newbie: {
                name: 'The Curious Explorer',
                icon: 'üå±',
                desc: 'Everyone starts somewhere, and you\'re at the beginning of an incredible journey. Your curiosity brought you here, and your courage to take the first step sets you apart. The crypto world is vast, complex, and full of opportunity. Welcome‚Äîyou\'re going to learn so much.',
                traits: [
                    'Learning mode - you\'re absorbing everything',
                    'Small positions - testing the waters carefully',
                    'Question asker - you seek to understand',
                    'Community learner - you follow experts and educators',
                    'Wallet experimenter - figuring out the tools',
                    'Cautious explorer - one step at a time',
                    'Growing confidence - each transaction teaches you'
                ],
                strengths: [
                    'Fresh perspective without bad habits',
                    'Eagerness to learn and improve',
                    'Low ego - willing to ask questions',
                    'Small position sizes limit potential losses'
                ],
                watchouts: [
                    'Vulnerability to scams - learn to spot red flags',
                    'Information overload - focus on basics first',
                    'FOMO pressure - don\'t rush into decisions',
                    'Security mistakes - practice proper wallet hygiene'
                ],
                advice: [
                    'Start with the basics: Bitcoin, Ethereum, and major protocols',
                    'üîê Security first: Hardware wallet, strong passwords, 2FA everywhere',
                    'üí∞ Never invest more than you can afford to lose',
                    'üéì Learn from mistakes: Every transaction is a lesson',
                    'üë• Find good communities: Quality > Hype',
                    'üìä Track everything: You\'ll thank yourself at tax time'
                ]
            }
        };

        let selectedChain = null;
        let walletAddress = null;
        
        // Tier System
        let currentTier = 'free'; // 'free', 'premium', 'pro'
        let dailyAnalysesUsed = 0;
        const DAILY_FREE_LIMIT = 3;
        
        // Tier Features
        const tierFeatures = {
            free: {
                dailyLimit: 3,
                chains: ['ethereum', 'bitcoin', 'solana'],
                features: ['basic-personality', 'basic-chart', 'basic-insights']
            },
            premium: {
                dailyLimit: -1, // unlimited
                chains: ['ethereum', 'bitcoin', 'solana', 'bsc', 'polygon', 'avalanche'],
                features: [
                    'basic-personality', 'basic-chart', 'basic-insights',
                    'wallet-health', 'portfolio-breakdown', 'transaction-patterns',
                    'contract-safety', 'multi-wallet', 'tax-export',
                    'personality-evolution', 'custom-alerts'
                ]
            },
            pro: {
                dailyLimit: -1, // unlimited
                chains: ['ethereum', 'bitcoin', 'solana', 'bsc', 'polygon', 'avalanche'],
                features: [
                    'basic-personality', 'basic-chart', 'basic-insights',
                    'wallet-health', 'portfolio-breakdown', 'transaction-patterns',
                    'contract-safety', 'multi-wallet', 'tax-export',
                    'personality-evolution', 'custom-alerts',
                    'ai-insights', 'whale-watching', 'peer-benchmark',
                    'what-if-analysis', 'advanced-charts', 'api-access',
                    'pdf-reports', 'priority-support'
                ]
            }
        };
        let chartInstance = null;
        let currentTimeframe = 'biweekly';
        let rawTransactions = null;
        let currentBalance = 0;
        const apiCache = new Map();

        // Multiple demo addresses for each chain - cycles through different wallets
        const demoWallets = {
            ethereum: [
                { address: '0xd8dA6BF26964aF9D7eEd9e03E53415D37aA96045', name: 'Vitalik Buterin' },
                { address: '0xab5801a7d398351b8be11c439e05c5b3259aec9b', name: 'Vitalik (Old Wallet)' },
                { address: '0x220866B1A2219f40e72f5c628B65D54268cA3A9D', name: 'Blur Marketplace' },
                { address: '0x28C6c06298d514Db089934071355E5743bf21d60', name: 'Binance 14' },
                { address: '0x47ac0Fb4F2D84898e4D9E7b4DaB3C24507a6D503', name: 'Binance Hot Wallet' }
            ],
            bitcoin: [
                { address: '1A1zP1eP5QGefi2DMPTfTL5SLmv7DivfNa', name: 'Genesis Block (Satoshi)' },
                { address: 'bc1qgdjqv0av3q56jvd82tkdjpy7gdp9ut8tlqmgrpmv24sq90ecnvqqjwvw97', name: 'Binance Cold Wallet' },
                { address: '3M219KR5vEneNb47ewrPfWyb5jQ2DjxRP6', name: 'Bitfinex Cold Storage' },
                { address: '1P5ZEDWTKTFGxQjZphgWPQUpe554WKDfHQ', name: 'Large BTC Holder' },
                { address: '12tkqA9xSoowkzoERHMWNKsTey55YEBqkv', name: 'Mt. Gox Cold Wallet' }
            ],
            solana: [
                { address: '9WzDXwBbmkg8ZTbNMqUxvQRAyrZzDsGYdLVL9zYtAWWM', name: 'Popular SOL Wallet' },
                { address: 'GThUX1Atko4tqhN2NaiTazWSeFWMuiUvfFnyJyUghFMJ', name: 'Phantom Team' },
                { address: 'H6ARHf6YXhGYeQfUzQNGk6rDNnLBQKrenN712K4AQJEG', name: 'FTX Cold Wallet' },
                { address: 'CuieVDEDtLo7FypA9SbLM9saXFdb1dsshEkyErMqkRQq', name: 'Solana Foundation' },
                { address: 'GjphYQcbP1m3FuDyCTUJf2mUMxKPE3j6feWU1rxvC7Ps', name: 'Magic Eden Treasury' }
            ],
            bsc: [
                { address: '0x8894E0a0c962CB723c1976a4421c95949bE2D4E3', name: 'Binance Hot Wallet' },
                { address: '0xBE0eB53F46cd790Cd13851d5EFf43D12404d33E8', name: 'Binance 8' },
                { address: '0xF977814e90dA44bFA03b6295A0616a897441aceC', name: 'Binance Cold Wallet 1' },
                { address: '0x5a52E96BAcdaBb82fd05763E25335261B270Efcb', name: 'PancakeSwap Main' },
                { address: '0x73feaa1eE314F8c655E354234017bE2193C9E24E', name: 'PancakeSwap MasterChef' }
            ],
            polygon: [
                { address: '0x7ceB23fD6bC0adD59E62ac25578270cFf1b9f619', name: 'WETH Bridge' },
                { address: '0x40ec5B33f54e0E8A33A975908C5BA1c14e5BbbDf', name: 'Polygon ERC20 Bridge' },
                { address: '0xa5E0829CaCEd8fFDD4De3c43696c57F7D7A678ff', name: 'QuickSwap Router' },
                { address: '0x0d500B1d8E8eF31E21C99d1Db9A6444d3ADf1270', name: 'WMATIC Token' },
                { address: '0x1a13F4Ca1d028320A707D99520AbFefca3998b7F', name: 'Aave Polygon' }
            ],
            avalanche: [
                { address: '0x9f8c163cBA728e99993ABe7495F06c0A3c8Ac8b9', name: 'Avalanche Foundation' },
                { address: '0x60aE616a2155Ee3d9A68541Ba4544862310933d4', name: 'Trader Joe Router' },
                { address: '0xB31f66AA3C1e785363F0875A1B74E27b85FD66c7', name: 'WAVAX Token' },
                { address: '0x8eBAf22B6F053dFFeaf46f4Dd9eFA95D89ba8580', name: 'Pangolin Router' },
                { address: '0x152b9d0FdC40C096757F570A51E494bd4b943E50', name: 'AVAX Bridge' }
            ]
        };
        
        // Track which demo wallet index to use for each chain
        const demoWalletIndex = {
            ethereum: 0,
            bitcoin: 0,
            solana: 0,
            bsc: 0,
            polygon: 0,
            avalanche: 0
        };

        // ==================== TIMEFRAME HELPER FUNCTIONS ====================
        
        function getTimeframeKey(date, timeframe) {
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            const day = date.getDate();
            
            switch(timeframe) {
                case 'daily':
                    return `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                case 'weekly':
                    const weekNum = Math.ceil(day / 7);
                    return `${year}-${String(month).padStart(2, '0')}-W${weekNum}`;
                case 'biweekly':
                    const period = day <= 14 ? 1 : 2;
                    return `${year}-${String(month).padStart(2, '0')}-P${period}`;
                case 'monthly':
                    return `${year}-${String(month).padStart(2, '0')}`;
                default:
                    return `${year}-${String(month).padStart(2, '0')}`;
            }
        }
        
        function getTimeframeLabel(date, timeframe) {
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const year = date.getFullYear();
            const month = date.getMonth();
            const day = date.getDate();
            
            switch(timeframe) {
                case 'daily':
                    return `${monthNames[month]} ${day}, ${year}`;
                case 'weekly':
                    const weekNum = Math.ceil(day / 7);
                    const weekStart = (weekNum - 1) * 7 + 1;
                    const weekEnd = Math.min(weekNum * 7, new Date(year, month + 1, 0).getDate());
                    return `${monthNames[month]} ${weekStart}-${weekEnd}`;
                case 'biweekly':
                    const period = day <= 14 ? 1 : 2;
                    const periodLabel = period === 1 ? '1-14' : '15-end';
                    return `${monthNames[month]} ${periodLabel}`;
                case 'monthly':
                    return `${monthNames[month]} ${year}`;
                default:
                    return `${monthNames[month]} ${year}`;
            }
        }

        // ==================== BLOCKCHAIN API FUNCTIONS ====================

        // Validate addresses
        function isValidEthereumAddress(address) {
            return /^0x[a-fA-F0-9]{40}$/.test(address);
        }

        function isValidBitcoinAddress(address) {
            return /^[13][a-km-zA-HJ-NP-Z1-9]{25,34}$/.test(address) || 
                   /^bc1[a-z0-9]{39,59}$/.test(address);
        }

        function isValidSolanaAddress(address) {
            return /^[1-9A-HJ-NP-Za-km-z]{32,44}$/.test(address);
        }

        // ETHEREUM API (using Etherscan as primary - most reliable!)
        async function getEthereumData(address, chainType = 'ethereum') {
            if (!isValidEthereumAddress(address)) {
                throw new Error('Invalid Ethereum address format');
            }

            // Try Etherscan first (most reliable)
            try {
                return await getEthereumDataViaEtherscan(address, chainType);
            } catch (etherscanError) {
                console.warn('Etherscan failed, trying Alchemy...', etherscanError);
                
                // Fallback to Alchemy for Ethereum
                if (chainType === 'ethereum') {
                    try {
                        return await getEthereumDataViaAlchemy(address);
                    } catch (alchemyError) {
                        console.error('Both Etherscan and Alchemy failed');
                        throw new Error('Unable to fetch wallet data. Please try again later.');
                    }
                } else {
                    throw etherscanError;
                }
            }
        }

        // Moralis API implementation (PRIMARY - most reliable!)
        async function getEthereumDataViaMoralis(address, chainType = 'ethereum') {
            console.log('=== USING MORALIS API ===');
            
            const cacheKey = `${chainType}-moralis:${address}`;
            if (apiCache.has(cacheKey)) {
                const cached = apiCache.get(cacheKey);
                if (Date.now() - cached.timestamp < 300000) {
                    return cached.data;
                }
            }

            // Map chain types to Moralis chain identifiers
            const chainMap = {
                'ethereum': '0x1',
                'bsc': '0x38',
                'polygon': '0x89',
                'avalanche': '0xa86a'
            };

            const chain = chainMap[chainType] || '0x1';
            
            updateLoadingStatus('Fetching data via Moralis...', 30);
            completeStep('step1');

            // Moralis uses RESTful API - no API key needed for basic calls
            const baseUrl = 'https://deep-index.moralis.io/api/v2.2';
            
            // Get wallet transactions
            const txUrl = `${baseUrl}/${address}?chain=${chain}`;
            console.log('Moralis TX URL:', txUrl);

            const headers = {
                'Accept': 'application/json',
                'X-API-Key': API_CONFIG.moralis.key
            };

            const txResponse = await fetch(txUrl, {
                method: 'GET',
                headers: headers
            });

            if (!txResponse.ok) {
                throw new Error(`Moralis API error: ${txResponse.status} - ${txResponse.statusText}`);
            }

            const walletData = await txResponse.json();
            console.log('Moralis wallet data:', walletData);

            completeStep('step2');
            updateLoadingStatus('Analyzing transactions...', 60);

            // Get native balance
            const balanceUrl = `${baseUrl}/${address}/balance?chain=${chain}`;
            console.log('Moralis Balance URL:', balanceUrl);

            const balanceResponse = await fetch(balanceUrl, {
                method: 'GET',
                headers: headers
            });

            const balanceData = await balanceResponse.json();
            console.log('Moralis balance data:', balanceData);

            const balance = parseFloat(balanceData.balance) / 1e18;

            // Get transaction history
            const historyUrl = `${baseUrl}/${address}?chain=${chain}&limit=100`;
            const historyResponse = await fetch(historyUrl, {
                method: 'GET',
                headers: headers
            });

            const historyData = await historyResponse.json();
            const transactions = historyData.result || [];

            completeStep('step3');

            // Convert Moralis format to our format
            const formattedTransactions = transactions.map(tx => ({
                hash: tx.hash,
                timeStamp: Math.floor(new Date(tx.block_timestamp).getTime() / 1000),
                from: tx.from_address,
                to: tx.to_address,
                value: tx.value,
                gasUsed: tx.gas_used || '0',
                gasPrice: tx.gas_price || '0',
                input: tx.input || '0x'
            }));

            const result = analyzeEthereumWallet(address, formattedTransactions, balance, chainType);
            
            apiCache.set(cacheKey, {
                data: result,
                timestamp: Date.now()
            });

            return result;
        }

        // Etherscan API V2 implementation (unified endpoint for all chains)
        async function getEthereumDataViaEtherscan(address, chainType = 'ethereum') {
            // Chains NOT supported on Etherscan free tier (as of Nov 2024)
            const freeNotSupported = ['bsc', 'avalanche'];
            
            if (freeNotSupported.includes(chainType)) {
                console.log(`=== ${chainType.toUpperCase()} NOT ON FREE TIER ===`);
                console.log('Falling back to public RPC via backend...');
                return await getDataViaPublicRPC(address, chainType);
            }
            
            console.log('=== SECURE BACKEND API CALL ===');
            console.log('Chain:', chainType);
            console.log('Calling backend proxy (API keys hidden)');

            // Check cache
            const cacheKey = `${chainType}:${address}`;
            if (apiCache.has(cacheKey)) {
                const cached = apiCache.get(cacheKey);
                if (Date.now() - cached.timestamp < 300000) {
                    console.log('Using cached data');
                    return cached.data;
                }
            }

            updateLoadingStatus('Fetching transaction history...', 30);
            completeStep('step1');

            try {
                // Call backend API instead of Etherscan directly
                const txUrl = `${API_CONFIG.backend}/api/etherscan/${chainType}/transactions?address=${address}`;
                
                console.log('Backend URL:', txUrl);
                console.log('‚úÖ API keys are secure on backend server');
                
                const txResponse = await fetch(txUrl);
                
                console.log('Response status:', txResponse.status);
                
                if (!txResponse.ok) {
                    const errorText = await txResponse.text();
                    console.error('Backend API Error:', errorText.substring(0, 500));
                    throw new Error(`Backend API returned ${txResponse.status}`);
                }
                
                const txData = await txResponse.json();

                console.log('=== API RESPONSE ===');
                console.log('Full Response:', txData);
                console.log('Status:', txData.status);
                console.log('Message:', txData.message);
                console.log('Result type:', typeof txData.result);
                console.log('Result length:', Array.isArray(txData.result) ? txData.result.length : 'N/A');

                if (txData.status !== '1') {
                    console.error('=== BACKEND ERROR DETAILS ===');
                    console.error('Full response:', txData);
                    throw new Error('Failed to fetch transaction data from backend');
                }

                completeStep('step2');
                updateLoadingStatus('Analyzing wallet...', 60);

                // Fetch balance via backend
                const balanceUrl = `${API_CONFIG.backend}/api/etherscan/${chainType}/balance?address=${address}`;
                
                console.log('Fetching balance via backend...');
                const balResponse = await fetch(balanceUrl);
                
                if (!balResponse.ok) {
                    throw new Error('Failed to fetch balance from backend');
                }
                
                const balData = await balResponse.json();

                console.log('Balance API response:', balData);

                if (balData.status !== '1') {
                    throw new Error('Failed to fetch balance');
                }

                const balance = parseFloat(balData.result) / 1e18;
                const transactions = txData.result;

                completeStep('step3');

                const result = analyzeEthereumWallet(address, transactions, balance, chainType);
                
                apiCache.set(cacheKey, {
                    data: result,
                    timestamp: Date.now()
                });

                return result;
            } catch (error) {
                console.error('Error in getEthereumDataViaEtherscan:', error);
                throw error;
            }
        }

        // Public RPC implementation for BSC/Avalanche via backend
        async function getDataViaPublicRPC(address, chainType) {
            console.log('=== USING BACKEND RPC PROXY ===');
            console.log('Chain:', chainType);
            
            updateLoadingStatus('Fetching balance via RPC...', 30);
            completeStep('step1');
            
            try {
                // Get current balance via backend
                const balanceUrl = `${API_CONFIG.backend}/api/rpc/${chainType}/balance?address=${address}`;
                const balanceResponse = await fetch(balanceUrl);
                
                if (!balanceResponse.ok) {
                    throw new Error(`Backend RPC request failed: ${balanceResponse.status}`);
                }
                
                const balanceData = await balanceResponse.json();
                console.log('Balance response:', balanceData);
            
            if (balanceData.error) {
                throw new Error(`RPC error: ${balanceData.error.message}`);
            }
            
            const balance = parseInt(balanceData.result, 16) / 1e18;
            
            completeStep('step2');
            updateLoadingStatus('Fetching transaction count...', 60);
            
            // Get transaction count via backend
            const txCountUrl = `${API_CONFIG.backend}/api/rpc/${chainType}/txcount?address=${address}`;
            const txCountResponse = await fetch(txCountUrl);
            
            if (!txCountResponse.ok) {
                throw new Error(`Backend transaction count request failed: ${txCountResponse.status}`);
            }
            
            const txCountData = await txCountResponse.json();
            const txCount = parseInt(txCountData.result, 16);
            
            console.log('Transaction count:', txCount);
            
            completeStep('step3');
            
            // Create simplified analysis (we don't have full tx history from RPC)
            const result = {
                personality: {
                    type: balance > 10 ? 'whale' : 
                          balance > 1 ? 'hodler' : 
                          txCount > 100 ? 'daytrader' : 'cautious',
                    stats: {
                        txCount: txCount,
                        balance: `${balance.toFixed(4)} ${chains[chainType].nativeCurrency}`,
                        walletAge: 'N/A (using public RPC)',
                        activityLevel: txCount > 100 ? 'High' : txCount > 50 ? 'Medium' : 'Low'
                    },
                    insights: [
                        `Current balance: ${balance.toFixed(4)} ${chains[chainType].nativeCurrency}`,
                        `Total transactions: ${txCount}`,
                        'Note: Limited data available via public RPC (no transaction history)',
                        'For full analysis, explorer APIs would need V2 endpoints'
                    ]
                },
                txCount: txCount,
                balance: balance,
                historicalData: [] // No historical data from public RPC
            };
            
            return result;
            } catch (error) {
                console.error('Error in getDataViaPublicRPC:', error);
                throw error;
            }
        }

        // Alchemy API implementation (fallback)
        async function getEthereumDataViaAlchemy(address) {
            console.log('=== USING ALCHEMY API ===');
            
            const cacheKey = `ethereum-alchemy:${address}`;
            if (apiCache.has(cacheKey)) {
                const cached = apiCache.get(cacheKey);
                if (Date.now() - cached.timestamp < 300000) {
                    return cached.data;
                }
            }

            updateLoadingStatus('Fetching data via Alchemy...', 30);
            completeStep('step1');

            // Get transaction count
            const txCountResponse = await fetch(API_CONFIG.alchemy.ethereum, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    jsonrpc: '2.0',
                    id: 1,
                    method: 'eth_getTransactionCount',
                    params: [address, 'latest']
                })
            });
            const txCountData = await txCountResponse.json();
            const txCount = parseInt(txCountData.result, 16);

            completeStep('step2');
            updateLoadingStatus('Analyzing wallet...', 60);

            // Get balance
            const balanceResponse = await fetch(API_CONFIG.alchemy.ethereum, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    jsonrpc: '2.0',
                    id: 2,
                    method: 'eth_getBalance',
                    params: [address, 'latest']
                })
            });
            const balanceData = await balanceResponse.json();
            const balance = parseInt(balanceData.result, 16) / 1e18;

            completeStep('step3');

            // Create simplified result since we don't have full transaction history
            const result = {
                personality: {
                    type: determinePersonalityFromBasicData(txCount, balance),
                    stats: {
                        txCount: txCount,
                        balance: `${balance.toFixed(4)} ETH`,
                        walletAge: 'Unknown',
                        activityLevel: txCount > 100 ? 'High' : txCount > 50 ? 'Medium' : 'Low'
                    },
                    insights: [
                        `You have ${txCount} total transactions`,
                        `Current balance: ${balance.toFixed(4)} ETH`,
                        'Using simplified analysis (Etherscan backup)'
                    ]
                },
                txCount: txCount,
                balance: balance,
                historicalData: []
            };

            apiCache.set(cacheKey, {
                data: result,
                timestamp: Date.now()
            });

            return result;
        }

        function determinePersonalityFromBasicData(txCount, balance) {
            if (balance > 10) return 'whale';
            if (balance > 1 && txCount < 50) return 'hodler';
            if (txCount > 500) return 'daytrader';
            if (txCount > 100) return 'defi';
            if (txCount < 10) return 'newbie';
            return 'cautious';
        }

        // BITCOIN API
        async function getBitcoinData(address) {
            if (!isValidBitcoinAddress(address)) {
                throw new Error('Invalid Bitcoin address format');
            }

            const cacheKey = `bitcoin:${address}`;
            if (apiCache.has(cacheKey)) {
                const cached = apiCache.get(cacheKey);
                if (Date.now() - cached.timestamp < 300000) {
                    return cached.data;
                }
            }

            updateLoadingStatus('Fetching Bitcoin data...', 30);
            completeStep('step1');

            // Call backend instead of blockchain.info directly
            const response = await fetch(`${API_CONFIG.backend}/api/bitcoin/transactions?address=${address}`);
            
            if (!response.ok) {
                throw new Error('Failed to fetch Bitcoin data from backend');
            }

            const data = await response.json();
            
            console.log('=== BITCOIN DATA (via Backend) ===');
            console.log('Total transactions:', data.n_tx);
            console.log('Transactions fetched:', data.txs.length);
            console.log('Oldest tx date:', data.txs[data.txs.length - 1] ? new Date(data.txs[data.txs.length - 1].time * 1000) : 'N/A');
            console.log('Newest tx date:', data.txs[0] ? new Date(data.txs[0].time * 1000) : 'N/A');
            
            completeStep('step2');
            updateLoadingStatus('Analyzing wallet...', 60);
            completeStep('step3');

            const result = analyzeBitcoinWallet(address, data);

            apiCache.set(cacheKey, {
                data: result,
                timestamp: Date.now()
            });

            return result;
        }

        // SOLANA API (via secure backend)
        async function getSolanaData(address) {
            if (!isValidSolanaAddress(address)) {
                throw new Error('Invalid Solana address format');
            }

            const cacheKey = `solana:${address}`;
            if (apiCache.has(cacheKey)) {
                const cached = apiCache.get(cacheKey);
                if (Date.now() - cached.timestamp < 300000) {
                    return cached.data;
                }
            }

            updateLoadingStatus('Fetching Solana data...', 30);
            completeStep('step1');

            console.log('=== USING BACKEND FOR SOLANA ===');

            // Get balance via backend
            const balanceResponse = await fetch(`${API_CONFIG.backend}/api/solana/balance?address=${address}`);
            
            if (!balanceResponse.ok) {
                throw new Error('Failed to fetch Solana balance from backend');
            }

            if (!balanceResponse.ok) {
                throw new Error(`Helius RPC error: ${balanceResponse.status}`);
            }

            const balanceData = await balanceResponse.json();
            console.log('Balance response:', balanceData);
            
            if (balanceData.error) {
                throw new Error(`Solana RPC error: ${balanceData.error.message}`);
            }

            const balance = balanceData.result?.value / 1e9 || 0;

            completeStep('step2');
            updateLoadingStatus('Analyzing transactions...', 60);

            // Get transaction signatures via backend
            const sigResponse = await fetch(`${API_CONFIG.backend}/api/solana/transactions?address=${address}`);
            
            if (!sigResponse.ok) {
                throw new Error('Failed to fetch Solana transactions from backend');
            }

            const sigData = await sigResponse.json();
            console.log('=== SOLANA DATA (via Backend) ===');
            console.log('Signatures fetched:', sigData.result?.length || 0);
            
            if (sigData.result && sigData.result.length > 0) {
                console.log('Oldest tx date:', new Date(sigData.result[sigData.result.length - 1].blockTime * 1000));
                console.log('Newest tx date:', new Date(sigData.result[0].blockTime * 1000));
            }

            if (sigData.error) {
                throw new Error(`Solana RPC error: ${sigData.error.message}`);
            }

            const transactions = sigData.result || [];

            completeStep('step3');

            const result = analyzeSolanaWallet(address, transactions, balance);

            apiCache.set(cacheKey, {
                data: result,
                timestamp: Date.now()
            });

            return result;
        }

        // ==================== WALLET ANALYSIS ====================

        function analyzeEthereumWallet(address, transactions, balance, chainType) {
            const txCount = transactions.length;

            // Calculate wallet age
            const firstTx = transactions[0];
            const walletAgeDays = firstTx ? 
                Math.floor((Date.now() - firstTx.timeStamp * 1000) / (1000 * 60 * 60 * 24)) : 0;

            // Calculate gas spent
            const totalGasSpent = transactions.reduce((sum, tx) => {
                return sum + (parseInt(tx.gasUsed || 0) * parseInt(tx.gasPrice || 0)) / 1e18;
            }, 0);

            // Contract interactions (DeFi activity)
            const contractInteractions = transactions.filter(tx => tx.to && tx.input !== '0x').length;
            const defiRatio = txCount > 0 ? contractInteractions / txCount : 0;

            // Activity level
            let activityLevel = 'Low';
            if (txCount > 100) activityLevel = 'Medium';
            if (txCount > 500) activityLevel = 'High';
            if (txCount > 1000) activityLevel = 'Very High';

            // Determine personality
            let personalityType = 'cautious';
            const insights = [];

            if (balance > 10) {
                personalityType = 'whale';
                insights.push(`You're a whale with ${balance.toFixed(2)} ${chains[chainType].nativeCurrency}!`);
                insights.push('Your wallet can make market moves');
            } else if (defiRatio > 0.6) {
                personalityType = 'defi';
                insights.push('You\'re heavily into DeFi protocols');
                insights.push(`${Math.round(defiRatio * 100)}% of your transactions are smart contract interactions`);
            } else if (balance > 1 && txCount < 50) {
                personalityType = 'hodler';
                insights.push('You have strong conviction in your holdings');
                insights.push(`Total gas spent: ${totalGasSpent.toFixed(4)} ${chains[chainType].nativeCurrency}`);
            } else if (txCount > 500) {
                personalityType = 'daytrader';
                insights.push('You\'re a highly active trader');
                insights.push(`Average ${(txCount / (walletAgeDays || 1)).toFixed(1)} transactions per day`);
            } else if (txCount > 100 && balance < 0.1) {
                personalityType = 'degen';
                insights.push('You love experimenting with new tokens');
                insights.push('High activity with moderate holdings');
            } else if (txCount < 10) {
                personalityType = 'newbie';
                insights.push('Welcome to the crypto space!');
                insights.push('You\'re just getting started on your journey');
            }

            // Historical data - calculate backwards from current balance for accuracy
            const historicalData = [];
            const timeframeData = {};
            
            // Start from current balance and work backwards through transactions
            let runningBalance = balance;
            
            // Process transactions in reverse order (newest to oldest)
            const reversedTxs = [...transactions].reverse();
            
            reversedTxs.forEach(tx => {
                const value = parseFloat(tx.value || 0) / 1e18;
                const date = new Date(tx.timeStamp * 1000);
                const timeKey = getTimeframeKey(date, currentTimeframe);
                const timeLabel = getTimeframeLabel(date, currentTimeframe);

                // Record balance BEFORE processing this transaction
                if (!timeframeData[timeKey]) {
                    historicalData.unshift({ // Add to beginning since we're going backwards
                        month: timeLabel,
                        balance: Math.max(0, runningBalance)
                    });
                    timeframeData[timeKey] = true;
                }
                
                // Now adjust balance for this transaction (reverse the effect)
                if (tx.from.toLowerCase() === address.toLowerCase()) {
                    runningBalance += value; // Was sent out, so add it back
                } else {
                    runningBalance -= value; // Was received, so subtract it
                }
            });
            
            // Store raw transactions and current balance for timeframe switching
            rawTransactions = transactions;
            currentBalance = balance;

            return {
                personality: {
                    type: personalityType,
                    stats: {
                        txCount: txCount,
                        balance: `${balance.toFixed(4)} ${chains[chainType].nativeCurrency}`,
                        walletAge: `${walletAgeDays} days`,
                        activityLevel: activityLevel
                    },
                    insights: insights
                },
                txCount: txCount,
                balance: balance,
                historicalData: historicalData.slice(-12)
            };
        }

        function analyzeBitcoinWallet(address, data) {
            const balance = data.final_balance / 1e8;
            const txCount = data.n_tx;
            const totalReceived = data.total_received / 1e8;
            const totalSent = data.total_sent / 1e8;

            // Calculate hodl ratio
            const hodlRatio = totalReceived > 0 ? balance / totalReceived : 0;

            // Activity level
            let activityLevel = 'Low';
            if (txCount > 50) activityLevel = 'Medium';
            if (txCount > 200) activityLevel = 'High';
            if (txCount > 500) activityLevel = 'Very High';

            // Determine personality
            let personalityType = 'cautious';
            const insights = [];

            if (balance > 10) {
                personalityType = 'whale';
                insights.push(`Massive Bitcoin holdings: ${balance.toFixed(4)} BTC`);
                insights.push('You\'re a Bitcoin whale!');
            } else if (hodlRatio > 0.8 && txCount < 50) {
                personalityType = 'hodler';
                insights.push('Strong Bitcoin hodler with diamond hands');
                insights.push(`${Math.round(hodlRatio * 100)}% of received BTC is still held`);
            } else if (txCount > 200) {
                personalityType = 'daytrader';
                insights.push('Active Bitcoin trader');
                insights.push(`Total volume: ${totalReceived.toFixed(4)} BTC received`);
            } else if (txCount < 10) {
                personalityType = 'newbie';
                insights.push('New to Bitcoin!');
                insights.push('Building your first positions');
            }

            // Calculate wallet age (estimate from first tx)
            const firstTx = data.txs[data.txs.length - 1];
            const walletAgeDays = firstTx ? 
                Math.floor((Date.now() - firstTx.time * 1000) / (1000 * 60 * 60 * 24)) : 0;

            // Generate historical balance data
            const historicalData = [];
            const timeframeData = {};
            let runningBalance = balance;
            
            console.log('=== GENERATING BTC HISTORY ===');
            console.log('Current balance:', balance, 'BTC');
            console.log('Total transactions to process:', data.txs.length);
            console.log('Current timeframe:', currentTimeframe);
            
            // Process transactions in reverse (newest to oldest)
            const reversedTxs = [...data.txs].reverse();
            
            reversedTxs.forEach((tx, index) => {
                const date = new Date(tx.time * 1000);
                const timeKey = getTimeframeKey(date, currentTimeframe);
                const timeLabel = getTimeframeLabel(date, currentTimeframe);
                
                if (index < 5) {
                    console.log(`TX ${index}: Date=${date.toISOString()}, TimeKey=${timeKey}, Label=${timeLabel}`);
                }
                
                // Record balance BEFORE this transaction
                if (!timeframeData[timeKey]) {
                    historicalData.unshift({
                        month: timeLabel,
                        balance: Math.max(0, runningBalance)
                    });
                    timeframeData[timeKey] = true;
                }
                
                // Calculate transaction effect
                let txValue = 0;
                
                // Calculate inputs (what was sent)
                if (tx.inputs) {
                    tx.inputs.forEach(input => {
                        if (input.prev_out && input.prev_out.addr === address) {
                            txValue -= input.prev_out.value / 1e8;
                        }
                    });
                }
                
                // Calculate outputs (what was received)
                if (tx.out) {
                    tx.out.forEach(output => {
                        if (output.addr === address) {
                            txValue += output.value / 1e8;
                        }
                    });
                }
                
                // Reverse the transaction effect
                runningBalance -= txValue;
            });
            
            // Store for timeframe switching
            rawTransactions = data.txs;
            currentBalance = balance;
            
            console.log('Historical data points generated:', historicalData.length);
            console.log('Date range:', 
                historicalData.length > 0 ? 
                `${historicalData[0].month} to ${historicalData[historicalData.length - 1].month}` : 
                'None');

            return {
                personality: {
                    type: personalityType,
                    stats: {
                        txCount: txCount,
                        balance: `${balance.toFixed(8)} BTC`,
                        walletAge: `${walletAgeDays} days`,
                        activityLevel: activityLevel
                    },
                    insights: insights
                },
                txCount: txCount,
                balance: balance,
                historicalData: historicalData
            };
        }

        function analyzeSolanaWallet(address, transactions, balance) {
            const txCount = transactions.length;

            // Activity level
            let activityLevel = 'Low';
            if (txCount > 50) activityLevel = 'Medium';
            if (txCount > 200) activityLevel = 'High';
            if (txCount > 500) activityLevel = 'Very High';

            // Determine personality
            let personalityType = 'cautious';
            const insights = [];

            if (balance > 100) {
                personalityType = 'whale';
                insights.push(`Significant Solana holdings: ${balance.toFixed(2)} SOL`);
            } else if (txCount > 300) {
                personalityType = 'daytrader';
                insights.push('Very active on Solana');
                insights.push('You love the speed and low fees');
            } else if (txCount > 100) {
                personalityType = 'defi';
                insights.push('Active DeFi user on Solana');
                insights.push('You understand Solana\'s DeFi ecosystem');
            } else if (balance > 1 && txCount < 30) {
                personalityType = 'hodler';
                insights.push('Holding SOL for the long term');
            } else if (txCount < 10) {
                personalityType = 'newbie';
                insights.push('New to Solana!');
                insights.push('Exploring the ecosystem');
            }

            // Estimate wallet age
            const firstTx = transactions[transactions.length - 1];
            const walletAgeDays = firstTx?.blockTime ? 
                Math.floor((Date.now() - firstTx.blockTime * 1000) / (1000 * 60 * 60 * 24)) : 0;

            // Generate historical balance data
            // Since we only have transaction signatures (not full tx details),
            // we'll create evenly distributed balance points as an approximation
            const historicalData = [];
            const timeframeData = {};
            
            console.log('=== GENERATING SOLANA HISTORY ===');
            console.log('Current balance:', balance, 'SOL');
            console.log('Total transactions:', txCount);
            console.log('Current timeframe:', currentTimeframe);
            
            if (transactions.length > 0) {
                // Process transactions to create timeframe buckets
                // Note: Solana transactions don't include balance changes in signatures
                // So we'll distribute the balance evenly across time periods
                
                transactions.forEach((tx, index) => {
                    if (tx.blockTime) {
                        const date = new Date(tx.blockTime * 1000);
                        const timeKey = getTimeframeKey(date, currentTimeframe);
                        const timeLabel = getTimeframeLabel(date, currentTimeframe);
                        
                        if (index < 5) {
                            console.log(`TX ${index}: Date=${date.toISOString()}, TimeKey=${timeKey}, Label=${timeLabel}`);
                        }
                        
                        // Record a data point for each unique time period
                        if (!timeframeData[timeKey]) {
                            // Approximate balance at this point (simplified - actual would need full tx data)
                            const progressRatio = 1 - (index / transactions.length);
                            const approximateBalance = balance * progressRatio;
                            
                            historicalData.push({
                                month: timeLabel,
                                balance: Math.max(0, approximateBalance)
                            });
                            timeframeData[timeKey] = true;
                        }
                    }
                });
                
                // Sort by date (oldest to newest)
                historicalData.sort((a, b) => {
                    // Extract date components for sorting
                    return 0; // Already in order from forEach
                });
            }
            
            // Store for timeframe switching
            rawTransactions = transactions;
            currentBalance = balance;
            
            console.log('Historical data points generated:', historicalData.length);
            console.log('Date range:', 
                historicalData.length > 0 ? 
                `${historicalData[0].month} to ${historicalData[historicalData.length - 1].month}` : 
                'None');

            return {
                personality: {
                    type: personalityType,
                    stats: {
                        txCount: txCount,
                        balance: `${balance.toFixed(4)} SOL`,
                        walletAge: `${walletAgeDays} days`,
                        activityLevel: activityLevel
                    },
                    insights: insights
                },
                txCount: txCount,
                balance: balance,
                historicalData: historicalData
            };
        }

        // ==================== UI FUNCTIONS ====================

        function selectChain(chain) {
            // Check if chain is available on current plan
            if (!isChainAvailable(chain)) {
                const requiredPlan = chain === 'ethereum' || chain === 'bitcoin' || chain === 'solana' ? 'free' : 'premium';
                alert(`üîí ${chains[chain].name} requires ${requiredPlan === 'premium' ? 'Premium' : 'Pro'} plan\n\nUpgrade to unlock all 6 chains!`);
                showUpgradePrompt();
                return;
            }
            
            // Check daily limit
            if (!canAnalyzeToday()) {
                alert(`‚ö†Ô∏è Daily limit reached!\n\nYou've used all ${PLANS[currentPlan].features.analysesPerDay} free analyses today.\n\nUpgrade to Premium for unlimited analyses!`);
                showUpgradePrompt();
                return;
            }
            
            selectedChain = chain;
            const chainInfo = chains[chain];
            
            document.querySelectorAll('.chain-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.closest('.chain-btn').classList.add('active');
            
            document.getElementById('selectedChainInfo').classList.remove('hidden');
            document.getElementById('selectedChainName').textContent = chainInfo.name;
            
            document.getElementById('connectWalletBtn').disabled = false;
            document.getElementById('manualAddress').disabled = false;
            document.getElementById('analyzeAddressBtn').disabled = false;
            
            // Show test address button
            document.getElementById('testAddressDiv').classList.remove('hidden');
        }

        function useTestAddress() {
            if (!selectedChain) return;
            
            const walletArray = demoWallets[selectedChain];
            if (walletArray && walletArray.length > 0) {
                // Get current index for this chain
                const currentIndex = demoWalletIndex[selectedChain];
                
                // Get the wallet at current index
                const wallet = walletArray[currentIndex];
                
                // Update index for next time (cycle through)
                demoWalletIndex[selectedChain] = (currentIndex + 1) % walletArray.length;
                
                // Show which demo wallet is being used
                const chainInfo = chains[selectedChain];
                showDemoWalletNotification(`Analyzing: ${wallet.name} on ${chainInfo.name}`);
                
                // Set the address and analyze
                document.getElementById('manualAddress').value = wallet.address;
                analyzeManualAddress();
            }
        }
        
        function showDemoWalletNotification(message) {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 glass p-4 rounded-xl text-white font-semibold z-50 fade-in';
            notification.style.boxShadow = '0 8px 32px rgba(0, 242, 254, 0.4)';
            
            // Create structure safely without innerHTML
            const container = document.createElement('div');
            container.className = 'flex items-center gap-3';
            
            const icon = document.createElement('span');
            icon.className = 'text-2xl';
            icon.textContent = 'üîç';
            
            const text = document.createElement('span');
            text.textContent = message; // Safe - uses textContent instead of innerHTML
            
            container.appendChild(icon);
            container.appendChild(text);
            notification.appendChild(container);
            
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.5s';
                setTimeout(() => notification.remove(), 500);
            }, 3000);
        }

        async function connectWallet() {
            if (!selectedChain) return;

            try {
                showLoading();
                document.getElementById('selectedChainDisplay').textContent = `Analyzing ${chains[selectedChain].name} wallet...`;
                
                if (selectedChain === 'ethereum' || selectedChain === 'bsc' || selectedChain === 'polygon' || selectedChain === 'avalanche') {
                    // Check if MetaMask is installed
                    if (typeof window.ethereum === 'undefined') {
                        showError('MetaMask not detected. Please install MetaMask extension or enter an address manually below.');
                        return;
                    }

                    try {
                        // Request account access
                        updateLoadingStatus('Requesting wallet access...', 10);
                        const accounts = await window.ethereum.request({ 
                            method: 'eth_requestAccounts' 
                        });
                        
                        if (!accounts || accounts.length === 0) {
                            showError('No accounts found. Please unlock MetaMask and try again.');
                            return;
                        }

                        walletAddress = accounts[0];
                        console.log('Connected wallet:', walletAddress);
                        
                        // Analyze the wallet
                        const result = await getEthereumData(walletAddress, selectedChain);
                        completeStep('step4');
                        updateLoadingStatus('Complete!', 100);
                        
                        setTimeout(() => {
                            showResults(result.personality, result.txCount, result.balance, result.historicalData);
                        }, 500);
                        
                    } catch (error) {
                        console.error('MetaMask error:', error);
                        if (error.code === 4001) {
                            showError('Connection rejected. Please approve the connection in MetaMask and try again.');
                        } else if (error.code === -32002) {
                            showError('Connection request pending. Please check MetaMask and approve the connection.');
                        } else {
                            throw error;
                        }
                    }
                } else if (selectedChain === 'solana') {
                    if (!window.solana || !window.solana.isPhantom) {
                        showError('Phantom wallet not detected. Please install Phantom extension or enter an address manually below.');
                        return;
                    }

                    try {
                        updateLoadingStatus('Requesting wallet access...', 10);
                        const response = await window.solana.connect();
                        walletAddress = response.publicKey.toString();
                        console.log('Connected Solana wallet:', walletAddress);
                        
                        const result = await getSolanaData(walletAddress);
                        completeStep('step4');
                        updateLoadingStatus('Complete!', 100);
                        
                        setTimeout(() => {
                            showResults(result.personality, result.txCount, result.balance, result.historicalData);
                        }, 500);
                    } catch (error) {
                        console.error('Phantom error:', error);
                        if (error.code === 4001) {
                            showError('Connection rejected. Please approve the connection in Phantom and try again.');
                        } else {
                            throw error;
                        }
                    }
                } else if (selectedChain === 'bitcoin') {
                    showError('Bitcoin wallet connection not supported. Please enter your Bitcoin address manually below.');
                } else {
                    showError('Wallet connection not available for this chain. Please enter address manually below.');
                }
            } catch (error) {
                console.error('Connection error:', error);
                
                let errorMessage = error.message || 'Failed to connect wallet';
                
                // Check if it's a network/CORS error
                if (error.message && error.message.includes('Failed to fetch')) {
                    errorMessage = `‚ùå Connection Error\n\nYou must run this app through a web server!\n\n1. Double-click START-SERVER.bat\n2. Open http://localhost:8080\n3. Navigate to wallet-personality-trendy.html\n\nDo NOT open the HTML file directly.`;
                }
                
                showError(errorMessage);
            }
        }

        async function analyzeManualAddress() {
            const rawAddress = document.getElementById('manualAddress').value;
            const address = rawAddress ? rawAddress.trim() : '';
            
            if (!address) {
                alert('‚ö†Ô∏è Please enter a wallet address');
                return;
            }

            if (!selectedChain) {
                alert('‚ö†Ô∏è Please select a blockchain first');
                return;
            }
            
            // Validate address format for security
            if (!isValidAddress(address, selectedChain)) {
                alert(`‚ö†Ô∏è Invalid ${chains[selectedChain].name} address format\n\nPlease check the address and try again.`);
                return;
            }

            try {
                // Use escaped address for safety
                walletAddress = escapeHTML(address);
                showLoading();
                document.getElementById('selectedChainDisplay').textContent = `Analyzing ${chains[selectedChain].name} wallet...`;
                
                let result;
                if (selectedChain === 'ethereum' || selectedChain === 'bsc' || selectedChain === 'polygon' || selectedChain === 'avalanche') {
                    result = await getEthereumData(address, selectedChain);
                } else if (selectedChain === 'bitcoin') {
                    result = await getBitcoinData(address);
                } else if (selectedChain === 'solana') {
                    result = await getSolanaData(address);
                } else {
                    throw new Error('Chain not supported yet');
                }

                completeStep('step4');
                updateLoadingStatus('Complete!', 100);
                
                setTimeout(() => {
                    showResults(result.personality, result.txCount, result.balance, result.historicalData);
                }, 500);
                
            } catch (error) {
                console.error('Error:', error);
                
                let errorMessage = error.message || 'Failed to analyze wallet';
                
                // Check if it's a network/CORS error
                if (error.message && error.message.includes('Failed to fetch')) {
                    errorMessage = `‚ùå Connection Error\n\nYou must run this app through a web server!\n\n1. Double-click START-SERVER.bat\n2. Open http://localhost:8080\n3. Navigate to wallet-personality-trendy.html\n\nDo NOT open the HTML file directly in your browser.`;
                } else if (error.message && error.message.includes('CORS')) {
                    errorMessage = `‚ùå CORS Error\n\nPlease run the app through http-server:\n\n1. Double-click START-SERVER.bat\n2. Open http://localhost:8080`;
                }
                
                showError(errorMessage);
            }
        }

        function regenerateChartData(timeframe) {
            if (!rawTransactions || rawTransactions.length === 0) {
                return [];
            }
            
            const historicalData = [];
            const timeframeData = {};
            
            // Check transaction format to determine blockchain type
            const firstTx = rawTransactions[0];
            const isSolana = firstTx.blockTime && !firstTx.timeStamp && !firstTx.time;
            const isBitcoin = firstTx.time && firstTx.inputs;
            const isEthereum = firstTx.timeStamp && firstTx.value !== undefined;
            
            if (isSolana) {
                // Solana - simplified balance approximation
                rawTransactions.forEach((tx, index) => {
                    if (tx.blockTime) {
                        const date = new Date(tx.blockTime * 1000);
                        const timeKey = getTimeframeKey(date, timeframe);
                        const timeLabel = getTimeframeLabel(date, timeframe);
                        
                        if (!timeframeData[timeKey]) {
                            const progressRatio = 1 - (index / rawTransactions.length);
                            const approximateBalance = currentBalance * progressRatio;
                            
                            historicalData.push({
                                month: timeLabel,
                                balance: Math.max(0, approximateBalance)
                            });
                            timeframeData[timeKey] = true;
                        }
                    }
                });
                
                return historicalData;
            }
            
            // For Bitcoin and Ethereum, calculate backwards from current balance
            let runningBalance = currentBalance;
            const reversedTxs = [...rawTransactions].reverse();
            
            reversedTxs.forEach(tx => {
                const date = new Date((tx.timeStamp || tx.time) * 1000);
                const timeKey = getTimeframeKey(date, timeframe);
                const timeLabel = getTimeframeLabel(date, timeframe);
                
                // Record balance BEFORE processing this transaction
                if (!timeframeData[timeKey]) {
                    historicalData.unshift({
                        month: timeLabel,
                        balance: Math.max(0, runningBalance)
                    });
                    timeframeData[timeKey] = true;
                }
                
                // Handle different transaction formats
                if (isEthereum) {
                    // Ethereum-style transaction
                    const value = parseFloat(tx.value || 0) / 1e18;
                    if (tx.from.toLowerCase() === walletAddress.toLowerCase()) {
                        runningBalance += value; // Was sent out, so add it back
                    } else {
                        runningBalance -= value; // Was received, so subtract it
                    }
                } else if (isBitcoin) {
                    // Bitcoin-style transaction
                    let txValue = 0;
                    
                    // Calculate inputs (what was sent)
                    if (tx.inputs) {
                        tx.inputs.forEach(input => {
                            if (input.prev_out && input.prev_out.addr === walletAddress) {
                                txValue -= input.prev_out.value / 1e8;
                            }
                        });
                    }
                    
                    // Calculate outputs (what was received)
                    if (tx.out) {
                        tx.out.forEach(output => {
                            if (output.addr === walletAddress) {
                                txValue += output.value / 1e8;
                            }
                        });
                    }
                    
                    // Reverse the transaction effect
                    runningBalance -= txValue;
                }
            });
            
            return historicalData;
        }
        
        function changeTimeframe(timeframe) {
            currentTimeframe = timeframe;
            
            // Update button styles
            document.querySelectorAll('.timeframe-btn').forEach(btn => {
                btn.classList.remove('timeframe-active');
            });
            document.getElementById(`btn-${timeframe}`).classList.add('timeframe-active');
            
            // Regenerate chart with new timeframe
            const newHistoricalData = regenerateChartData(timeframe);
            createPortfolioChart(newHistoricalData);
        }

        function createPortfolioChart(historicalData) {
            const canvas = document.getElementById('portfolioChart');
            const chartContainer = canvas.parentElement;
            
            // Destroy old chart instance if it exists
            if (chartInstance) {
                chartInstance.destroy();
                chartInstance = null;
            }

            // Show/hide chart container based on data availability
            if (!historicalData || historicalData.length === 0) {
                chartContainer.style.display = 'none';
                return;
            }

            chartContainer.style.display = 'block';
            const ctx = canvas.getContext('2d');
            const chainInfo = chains[selectedChain];
            
            // Small delay to ensure proper cleanup
            setTimeout(() => {
                chartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: historicalData.map(d => d.month),
                        datasets: [{
                            label: `Balance (${chainInfo.nativeCurrency})`,
                            data: historicalData.map(d => d.balance),
                            borderColor: 'rgb(0, 242, 254)',
                            backgroundColor: 'rgba(0, 242, 254, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            fill: true,
                            pointBackgroundColor: 'rgb(0, 242, 254)',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    color: '#fff',
                                    font: {
                                        size: 14,
                                        weight: '600'
                                    }
                                }
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                backgroundColor: 'rgba(10, 14, 26, 0.95)',
                                padding: 16,
                                titleColor: '#00f2fe',
                                bodyColor: '#fff',
                                borderColor: 'rgb(0, 242, 254)',
                                borderWidth: 2,
                                titleFont: {
                                    size: 14,
                                    weight: 'bold'
                                },
                                bodyFont: {
                                    size: 13
                                },
                                callbacks: {
                                    label: function(context) {
                                        const value = context.parsed.y;
                                        let formatted;
                                        
                                        // Smart formatting based on value size
                                        if (value === 0) {
                                            formatted = '0';
                                        } else if (value < 0.0001) {
                                            formatted = value.toExponential(2); // Scientific notation
                                        } else if (value < 0.01) {
                                            formatted = value.toFixed(6);
                                        } else if (value < 1) {
                                            formatted = value.toFixed(4);
                                        } else if (value < 100) {
                                            formatted = value.toFixed(2);
                                        } else {
                                            formatted = value.toLocaleString(undefined, {
                                                minimumFractionDigits: 0,
                                                maximumFractionDigits: 2
                                            });
                                        }
                                        
                                        return `${chainInfo.nativeCurrency}: ${formatted}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false, // Don't force zero for better small value visibility
                                grace: '10%', // Add 10% padding above/below for better visibility
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)',
                                    borderColor: 'rgba(255, 255, 255, 0.2)'
                                },
                                ticks: {
                                    color: '#fff',
                                    font: {
                                        size: 12
                                    },
                                    callback: function(value) {
                                        // Smart formatting based on value size
                                        if (value === 0) return '0';
                                        if (value < 0.0001) return value.toExponential(2); // Scientific notation for tiny values
                                        if (value < 0.01) return value.toFixed(6); // 6 decimals for small values
                                        if (value < 1) return value.toFixed(4); // 4 decimals for medium-small
                                        if (value < 100) return value.toFixed(2); // 2 decimals for normal
                                        return value.toFixed(0); // No decimals for large values
                                    }
                                }
                            },
                            x: {
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.05)',
                                    borderColor: 'rgba(255, 255, 255, 0.2)'
                                },
                                ticks: {
                                    color: '#fff',
                                    font: {
                                        size: 11
                                    },
                                    maxRotation: 45,
                                    minRotation: 45
                                }
                            }
                        }
                    }
                });
            }, 100);
        }

        function showUpgradePrompt() {
            // Scroll to upgrade section if on results page
            const upgradeSection = document.getElementById('upgradePromptSection');
            if (upgradeSection && !upgradeSection.classList.contains('hidden')) {
                upgradeSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }
        
        function upgradeToPremium() {
            alert('üöÄ Upgrading to Premium!\n\nIn production, this would:\n‚Ä¢ Process payment ($9.99/mo)\n‚Ä¢ Unlock all premium features\n‚Ä¢ Enable unlimited analyses\n\nFor demo: Setting plan to Premium...');
            currentPlan = 'premium';
            updatePlanBadge();
            updatePremiumFeatures();
        }
        
        function upgradeToPro() {
            alert('üöÄ Upgrading to Pro!\n\nIn production, this would:\n‚Ä¢ Process payment ($29.99/mo)\n‚Ä¢ Unlock ALL features\n‚Ä¢ Enable API access\n\nFor demo: Setting plan to Pro...');
            currentPlan = 'pro';
            updatePlanBadge();
            updatePremiumFeatures();
        }
        
        function updatePlanBadge() {
            const badge = document.getElementById('currentPlanBadge');
            
            // Clear existing content
            badge.innerHTML = '';
            
            if (currentPlan === 'free') {
                const planName = document.createElement('span');
                planName.className = 'text-sm font-semibold';
                planName.textContent = 'üÜì FREE PLAN';
                
                const separator = document.createElement('span');
                separator.className = 'text-xs text-white/60';
                separator.textContent = '|';
                
                const usage = document.createElement('span');
                usage.id = 'dailyUsage';
                usage.className = 'text-xs text-white/60';
                usage.textContent = `${analysesUsedToday}/3 today`;
                
                badge.appendChild(planName);
                badge.appendChild(separator);
                badge.appendChild(usage);
            } else if (currentPlan === 'premium') {
                const planName = document.createElement('span');
                planName.className = 'text-sm font-semibold text-cyan-400';
                planName.textContent = 'üíé PREMIUM';
                
                const detail = document.createElement('span');
                detail.className = 'text-xs text-cyan-400/60';
                detail.textContent = 'Unlimited Analyses';
                
                badge.appendChild(planName);
                badge.appendChild(detail);
            } else if (currentPlan === 'pro') {
                const planName = document.createElement('span');
                planName.className = 'text-sm font-semibold text-purple-400';
                planName.textContent = 'üöÄ PRO';
                
                const detail = document.createElement('span');
                detail.className = 'text-xs text-purple-400/60';
                detail.textContent = 'All Features Unlocked';
                
                badge.appendChild(planName);
                badge.appendChild(detail);
            }
        }
        
        function cyclePlan() {
            if (currentPlan === 'free') {
                currentPlan = 'premium';
            } else if (currentPlan === 'premium') {
                currentPlan = 'pro';
            } else {
                currentPlan = 'free';
                analysesUsedToday = 0;
            }
            updatePlanBadge();
            alert(`Plan switched to: ${PLANS[currentPlan].name}\n\nFeatures updated! Try selecting locked chains or view premium features.`);
        }
        
        function updatePremiumFeatures() {
            // Show/hide features based on plan
            const showHealth = hasAccess('walletHealthScore');
            const showPortfolio = hasAccess('portfolioBreakdown');
            const showPatterns = hasAccess('transactionPatterns');
            
            document.getElementById('walletHealthSection').style.display = showHealth ? 'block' : 'none';
            document.getElementById('portfolioBreakdownSection').style.display = showPortfolio ? 'block' : 'none';
            document.getElementById('transactionPatternsSection').style.display = showPatterns ? 'block' : 'none';
            
            // Show upgrade prompt for free users, hide for others
            document.getElementById('upgradePromptSection').style.display = currentPlan === 'free' ? 'block' : 'none';
        }
        
        function incrementAnalysisCount() {
            analysesUsedToday++;
            updatePlanBadge();
        }

        function showResults(personality, txCount, balance, historicalData) {
            const p = personalities[personality.type];
            const chainInfo = chains[selectedChain];
            
            // Store for NFT minting
            currentPersonalityType = personality.type;
            
            // Increment analysis count
            incrementAnalysisCount();
            
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('resultsScreen').classList.remove('hidden');
            
            // Update premium features visibility
            updatePremiumFeatures();
            
            document.getElementById('resultChainIcon').textContent = chainInfo.icon;
            document.getElementById('resultChainName').textContent = chainInfo.name;
            document.getElementById('personalityIcon').textContent = p.icon;
            document.getElementById('personalityType').textContent = p.name;
            document.getElementById('personalityDesc').textContent = p.desc;
            document.getElementById('statTxCount').textContent = personality.stats.txCount;
            document.getElementById('statWalletAge').textContent = personality.stats.walletAge;
            document.getElementById('statBalance').textContent = personality.stats.balance;
            document.getElementById('statActivity').textContent = personality.stats.activityLevel;
            
            // Update NFT Preview
            document.getElementById('nftPreviewIcon').textContent = p.icon;
            document.getElementById('nftPreviewType').textContent = p.name;
            document.getElementById('nftPreviewChain').textContent = chainInfo.name;
            document.getElementById('nftPreviewTx').textContent = personality.stats.txCount;
            document.getElementById('nftPreviewAge').textContent = personality.stats.walletAge;
            
            // Generate random edition number (1-9999)
            const editionNumber = Math.floor(Math.random() * 9999) + 1;
            document.getElementById('nftEditionNumber').textContent = editionNumber.toString().padStart(4, '0');
            
            // Traits
            const traitsList = document.getElementById('traits');
            traitsList.innerHTML = '';
            p.traits.forEach(trait => {
                const li = document.createElement('li');
                li.className = 'flex items-start text-white/90';
                
                const icon = document.createElement('span');
                icon.className = 'text-cyan-400 mr-3 text-xl';
                icon.textContent = '‚úì';
                
                const text = document.createElement('span');
                text.textContent = trait;
                
                li.appendChild(icon);
                li.appendChild(text);
                traitsList.appendChild(li);
            });
            
            // Strengths (if available)
            if (p.strengths && p.strengths.length > 0) {
                document.getElementById('strengthsSection').style.display = 'block';
                const strengthsList = document.getElementById('strengths');
                strengthsList.innerHTML = '';
                p.strengths.forEach(strength => {
                    const li = document.createElement('li');
                    li.className = 'flex items-start';
                    
                    const icon = document.createElement('span');
                    icon.className = 'text-green-400 mr-3 text-xl';
                    icon.textContent = '‚Ä¢';
                    
                    const text = document.createElement('span');
                    text.textContent = strength;
                    
                    li.appendChild(icon);
                    li.appendChild(text);
                    strengthsList.appendChild(li);
                });
            } else {
                document.getElementById('strengthsSection').style.display = 'none';
            }
            
            // Watch Outs (if available)
            if (p.watchouts && p.watchouts.length > 0) {
                document.getElementById('watchoutsSection').style.display = 'block';
                const watchoutsList = document.getElementById('watchouts');
                watchoutsList.innerHTML = '';
                p.watchouts.forEach(watchout => {
                    const li = document.createElement('li');
                    li.className = 'flex items-start';
                    
                    const icon = document.createElement('span');
                    icon.className = 'text-yellow-400 mr-3 text-xl';
                    icon.textContent = '‚Ä¢';
                    
                    const text = document.createElement('span');
                    text.textContent = watchout;
                    
                    li.appendChild(icon);
                    li.appendChild(text);
                    watchoutsList.appendChild(li);
                });
            } else {
                document.getElementById('watchoutsSection').style.display = 'none';
            }
            
            // Advice (if available - usually for newbies)
            if (p.advice && p.advice.length > 0) {
                document.getElementById('adviceSection').style.display = 'block';
                const adviceList = document.getElementById('advice');
                adviceList.innerHTML = '';
                p.advice.forEach(tip => {
                    const li = document.createElement('li');
                    li.className = 'flex items-start';
                    
                    const icon = document.createElement('span');
                    icon.className = 'text-purple-400 mr-3 text-xl';
                    icon.textContent = '‚Ä¢';
                    
                    const text = document.createElement('span');
                    text.textContent = tip;
                    
                    li.appendChild(icon);
                    li.appendChild(text);
                    adviceList.appendChild(li);
                });
            } else {
                document.getElementById('adviceSection').style.display = 'none';
            }
            
            // Insights
            const insightsDiv = document.getElementById('insights');
            insightsDiv.innerHTML = '';
            personality.insights.forEach(insight => {
                const p = document.createElement('p');
                p.className = 'flex items-start';
                
                const icon = document.createElement('span');
                icon.className = 'text-cyan-400 mr-3 text-xl';
                icon.textContent = '‚Ä¢';
                
                const text = document.createElement('span');
                text.textContent = insight;
                
                p.appendChild(icon);
                p.appendChild(text);
                insightsDiv.appendChild(p);
            });
            
            const shortAddress = walletAddress.slice(0, 6) + '...' + walletAddress.slice(-4);
            document.getElementById('walletAddress').textContent = shortAddress;
            
            if (historicalData && historicalData.length > 0) {
                createPortfolioChart(historicalData);
            }
        }

        function showLoading() {
            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('loadingScreen').classList.remove('hidden');
        }

        function updateLoadingStatus(message, progress) {
            document.getElementById('loadingStatus').textContent = message;
            document.getElementById('loadingBar').style.width = progress + '%';
        }

        function completeStep(stepId) {
            const step = document.getElementById(stepId);
            step.classList.remove('text-white/40');
            step.classList.add('text-cyan-400');
            step.querySelector('span').textContent = '‚úì';
        }

        function showError(message) {
            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('errorScreen').classList.remove('hidden');
            
            // Format the error message with line breaks
            const errorElement = document.getElementById('errorMessage');
            errorElement.style.whiteSpace = 'pre-wrap';
            errorElement.style.textAlign = 'left';
            errorElement.textContent = message;
        }

        function restartTest() {
            selectedChain = null;
            walletAddress = null;
            
            // Destroy chart if it exists
            if (chartInstance) {
                chartInstance.destroy();
                chartInstance = null;
            }
            
            document.getElementById('resultsScreen').classList.add('hidden');
            document.getElementById('errorScreen').classList.add('hidden');
            document.getElementById('startScreen').classList.remove('hidden');
            document.getElementById('selectedChainInfo').classList.add('hidden');
            document.getElementById('manualAddress').value = '';
            document.querySelectorAll('.chain-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById('connectWalletBtn').disabled = true;
            document.getElementById('manualAddress').disabled = true;
            document.getElementById('analyzeAddressBtn').disabled = true;
            document.getElementById('testAddressDiv').classList.add('hidden');
            
            ['step1', 'step2', 'step3', 'step4'].forEach(id => {
                const step = document.getElementById(id);
                step.classList.remove('text-cyan-400');
                step.classList.add('text-white/40');
                step.querySelector('span').textContent = '‚óã';
            });
        }

        async function mintNFT() {
            // Get current personality data
            const p = personalities[currentPersonalityType];
            const chainInfo = chains[selectedChain];
            
            // Show confirmation dialog
            const confirmed = confirm(
                `üé® Mint Your Personality Certificate NFT!\n\n` +
                `Type: ${p.name}\n` +
                `Chain: ${chainInfo.name}\n` +
                `Price: $19.99\n\n` +
                `This will create a unique NFT certificate of your wallet personality on Solana.\n\n` +
                `Ready to proceed?`
            );
            
            if (!confirmed) return;
            
            // In a real implementation, this would:
            // 1. Connect to user's wallet (Phantom, Solflare, etc.)
            // 2. Call smart contract to mint NFT
            // 3. Process payment ($19.99 or SOL equivalent)
            // 4. Generate unique artwork
            // 5. Mint on Solana
            
            alert(
                `üöß NFT Minting Coming Soon!\n\n` +
                `We're building the smart contract infrastructure on Solana.\n\n` +
                `Your personality: ${p.name} ${p.icon}\n\n` +
                `Join our waitlist at walletdna.io to get notified when minting goes live!\n\n` +
                `Early supporters get 50% off! üéâ`
            );
            
            // Track interest (you can add analytics here)
            console.log('NFT Mint Interest:', {
                personality: p.name,
                chain: chainInfo.name,
                wallet: walletAddress
            });
        }
        
        // Store current personality for NFT minting
        let currentPersonalityType = 'hodler';

        function shareResults() {
            const personalityName = document.getElementById('personalityType').textContent;
            const icon = document.getElementById('personalityIcon').textContent;
            const chainInfo = chains[selectedChain];
            const text = `I just analyzed my ${chainInfo.name} wallet and I'm ${icon} ${personalityName}! Find out your crypto personality!`;
            
            if (navigator.share) {
                navigator.share({ 
                    title: 'My Crypto Personality', 
                    text: text 
                });
            } else {
                navigator.clipboard.writeText(text).then(() => {
                    alert('Results copied to clipboard!');
                });
            }
        }
    </script>
</body>
</html>
