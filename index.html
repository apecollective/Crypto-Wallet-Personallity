<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Chain Wallet Personality Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body class="bg-gradient-to-br from-indigo-900 via-purple-900 to-pink-900 min-h-screen flex items-center justify-center p-4">
    <div class="max-w-4xl w-full bg-white/95 backdrop-blur rounded-2xl shadow-2xl p-8">
        
        <!-- Start Screen -->
        <div id="startScreen" class="text-center">
            <div class="text-6xl mb-4">üîÆ</div>
            <h1 class="text-4xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent mb-4">
                Multi-Chain Wallet Personality Test
            </h1>
            <p class="text-gray-600 mb-8 text-lg">
                Analyze wallets across multiple crypto networks and discover your on-chain personality!
            </p>

            <div class="bg-green-50 border-2 border-green-300 rounded-lg p-4 mb-6">
                <h3 class="font-bold text-green-900 mb-2">‚úì API Keys Configured</h3>
                <p class="text-green-800 text-sm">Ready to analyze real blockchain data!</p>
            </div>

            <!-- Chain Selection -->
            <div class="mb-8">
                <h3 class="text-lg font-bold text-gray-800 mb-4">Select Blockchain:</h3>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                    <button onclick="selectChain('bitcoin')" class="chain-btn border-2 border-gray-300 rounded-lg p-4 hover:border-orange-500 hover:bg-orange-50 transition">
                        <div class="text-3xl mb-1">‚Çø</div>
                        <div class="font-semibold">Bitcoin</div>
                        <div class="text-xs text-gray-500">BTC</div>
                    </button>

                    <button onclick="selectChain('ethereum')" class="chain-btn border-2 border-gray-300 rounded-lg p-4 hover:border-purple-500 hover:bg-purple-50 transition">
                        <div class="text-3xl mb-1">‚ü†</div>
                        <div class="font-semibold">Ethereum</div>
                        <div class="text-xs text-gray-500">ETH</div>
                    </button>

                    <button onclick="selectChain('solana')" class="chain-btn border-2 border-gray-300 rounded-lg p-4 hover:border-purple-500 hover:bg-purple-50 transition">
                        <div class="text-3xl mb-1">‚óé</div>
                        <div class="font-semibold">Solana</div>
                        <div class="text-xs text-gray-500">SOL</div>
                    </button>

                    <button onclick="selectChain('bsc')" class="chain-btn border-2 border-gray-300 rounded-lg p-4 hover:border-yellow-500 hover:bg-yellow-50 transition">
                        <div class="text-3xl mb-1">üü°</div>
                        <div class="font-semibold">BNB Chain</div>
                        <div class="text-xs text-gray-500">BNB</div>
                    </button>

                    <button onclick="selectChain('polygon')" class="chain-btn border-2 border-gray-300 rounded-lg p-4 hover:border-purple-500 hover:bg-purple-50 transition">
                        <div class="text-3xl mb-1">‚¨°</div>
                        <div class="font-semibold">Polygon</div>
                        <div class="text-xs text-gray-500">MATIC</div>
                    </button>

                    <button onclick="selectChain('avalanche')" class="chain-btn border-2 border-gray-300 rounded-lg p-4 hover:border-red-500 hover:bg-red-50 transition">
                        <div class="text-3xl mb-1">üî∫</div>
                        <div class="font-semibold">Avalanche</div>
                        <div class="text-xs text-gray-500">AVAX</div>
                    </button>
                </div>
            </div>

            <div id="selectedChainInfo" class="hidden mb-6 p-4 bg-purple-50 rounded-lg border border-purple-200">
                <p class="text-purple-800">
                    <span class="font-bold">Selected:</span> 
                    <span id="selectedChainName"></span>
                </p>
                <p class="text-sm text-purple-600 mt-1" id="chainNote">‚úì Ready to analyze!</p>
            </div>

            <!-- Connection Options -->
            <div class="space-y-4">
                <button id="connectWalletBtn" onclick="connectWallet()" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white font-bold py-4 px-8 rounded-full text-lg transition duration-300 transform hover:scale-105 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    <span id="connectBtnText">üîó Connect Wallet & Analyze</span>
                </button>
                
                <div class="flex items-center gap-4">
                    <div class="flex-1 h-px bg-gray-300"></div>
                    <span class="text-gray-500 text-sm">OR</span>
                    <div class="flex-1 h-px bg-gray-300"></div>
                </div>

                <div>
                    <input 
                        type="text" 
                        id="manualAddress" 
                        placeholder="Enter wallet address" 
                        class="w-full p-4 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none mb-3"
                        disabled
                    />
                    <button id="analyzeAddressBtn" onclick="analyzeManualAddress()" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-bold py-4 px-8 rounded-full text-lg transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        üîç Analyze This Address
                    </button>
                </div>
            </div>
            
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mt-6 text-sm text-left">
                <h3 class="font-bold text-blue-900 mb-2">üîí Privacy & Security</h3>
                <ul class="text-blue-800 space-y-1">
                    <li>‚úì Read-only analysis (no transactions)</li>
                    <li>‚úì Real blockchain data via API</li>
                    <li>‚úì Works with MetaMask, Phantom, and more</li>
                    <li>‚úì Or analyze any public address</li>
                </ul>
            </div>
        </div>

        <!-- Loading Screen -->
        <div id="loadingScreen" class="hidden text-center">
            <div class="text-6xl mb-4 animate-bounce">üîç</div>
            <h2 class="text-3xl font-bold text-gray-800 mb-4">Analyzing Your Wallet...</h2>
            <p class="text-gray-600 mb-2"><span id="selectedChainDisplay"></span></p>
            <p class="text-gray-600 mb-6" id="loadingStatus">Connecting...</p>
            
            <div class="bg-gray-200 rounded-full h-3 mb-6 overflow-hidden">
                <div id="loadingBar" class="bg-gradient-to-r from-purple-600 to-pink-600 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
            </div>
            
            <div class="text-left bg-gray-50 rounded-lg p-4 space-y-2 text-sm">
                <div id="step1" class="flex items-center text-gray-400">
                    <span class="mr-3 text-lg">‚óã</span>
                    <span>Connecting to blockchain...</span>
                </div>
                <div id="step2" class="flex items-center text-gray-400">
                    <span class="mr-3 text-lg">‚óã</span>
                    <span>Fetching transaction history...</span>
                </div>
                <div id="step3" class="flex items-center text-gray-400">
                    <span class="mr-3 text-lg">‚óã</span>
                    <span>Analyzing patterns...</span>
                </div>
                <div id="step4" class="flex items-center text-gray-400">
                    <span class="mr-3 text-lg">‚óã</span>
                    <span>Determining personality...</span>
                </div>
            </div>
        </div>

        <!-- Results Screen -->
        <div id="resultsScreen" class="hidden">
            <div class="text-center mb-8">
                <div class="flex items-center justify-center gap-3 mb-4">
                    <div id="resultChainIcon" class="text-5xl"></div>
                    <div>
                        <h2 class="text-3xl font-bold text-gray-800">Your <span id="resultChainName"></span> Personality</h2>
                    </div>
                </div>
            </div>

            <div class="bg-gradient-to-br from-purple-100 to-pink-100 rounded-2xl p-8 mb-8">
                <div class="text-center">
                    <div id="personalityIcon" class="text-8xl mb-4"></div>
                    <h3 id="personalityType" class="text-4xl font-bold text-purple-900 mb-3"></h3>
                    <p id="personalityDesc" class="text-gray-700 text-lg"></p>
                </div>
            </div>

            <div class="grid md:grid-cols-2 gap-6 mb-8">
                <div class="bg-white border-2 border-gray-200 rounded-xl p-6">
                    <h4 class="text-sm font-semibold text-gray-500 mb-2">Total Transactions</h4>
                    <p id="statTxCount" class="text-3xl font-bold text-purple-600"></p>
                </div>
                <div class="bg-white border-2 border-gray-200 rounded-xl p-6">
                    <h4 class="text-sm font-semibold text-gray-500 mb-2">Wallet Age</h4>
                    <p id="statWalletAge" class="text-3xl font-bold text-purple-600"></p>
                </div>
                <div class="bg-white border-2 border-gray-200 rounded-xl p-6">
                    <h4 class="text-sm font-semibold text-gray-500 mb-2">Current Balance</h4>
                    <p id="statBalance" class="text-3xl font-bold text-purple-600"></p>
                </div>
                <div class="bg-white border-2 border-gray-200 rounded-xl p-6">
                    <h4 class="text-sm font-semibold text-gray-500 mb-2">Activity Level</h4>
                    <p id="statActivity" class="text-3xl font-bold text-purple-600"></p>
                </div>
            </div>

            <div class="bg-white border-2 border-gray-200 rounded-xl p-6 mb-6">
                <h4 class="text-xl font-bold text-gray-800 mb-4">‚ú® Your Traits</h4>
                <ul id="traits" class="space-y-3"></ul>
            </div>

            <div class="bg-gradient-to-br from-blue-50 to-purple-50 border-2 border-purple-200 rounded-xl p-6 mb-6">
                <h4 class="text-xl font-bold text-gray-800 mb-4">üí° Insights</h4>
                <div id="insights" class="space-y-3 text-gray-700"></div>
            </div>

            <div class="bg-white border-2 border-gray-200 rounded-xl p-6 mb-6">
                <h4 class="text-xl font-bold text-gray-800 mb-4">üìä Balance History</h4>
                <canvas id="portfolioChart"></canvas>
            </div>

            <div class="text-center text-sm text-gray-600 mb-6">
                <p>Wallet: <span id="walletAddress" class="font-mono"></span></p>
            </div>

            <div class="flex gap-4">
                <button onclick="shareResults()" class="flex-1 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-bold py-4 px-8 rounded-full transition">
                    üì§ Share Results
                </button>
                <button onclick="restartTest()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-4 px-8 rounded-full transition">
                    üîÑ Test Another
                </button>
            </div>
        </div>

        <!-- Error Screen -->
        <div id="errorScreen" class="hidden text-center">
            <div class="text-6xl mb-4">‚ö†Ô∏è</div>
            <h2 class="text-3xl font-bold text-gray-800 mb-4">Oops!</h2>
            <p id="errorMessage" class="text-gray-600 mb-8"></p>
            <button onclick="restartTest()" class="bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white font-bold py-4 px-8 rounded-full text-lg transition">
                Try Again
            </button>
        </div>

    </div>

    <script>
        // ==================== CONFIGURATION ====================
        
        // API Keys are hardcoded and ready to use!
        const API_CONFIG = {
            etherscan: {
                key: '2MVET94BZC1VKINQ4QZVFVBV8SQKNWRUUQ',
                mainnet: 'https://api.etherscan.io/api',
                bsc: 'https://api.bscscan.com/api',
                polygon: 'https://api.polygonscan.com/api'
            },
            helius: {
                key: 'bbd9292e-e6e2-4d83-8567-d82d6286a2af',
                endpoint: 'https://api.helius.xyz/v0'
            },
            avalanche: {
                key: '2MVET94BZC1VKINQ4QZVFVBV8SQKNWRUUQ',
                snowtrace: 'https://api.snowtrace.io/api'
            }
        };

        const chains = {
            ethereum: {
                name: 'Ethereum',
                icon: '‚ü†',
                nativeCurrency: 'ETH',
                explorer: 'etherscan.io'
            },
            bitcoin: {
                name: 'Bitcoin',
                icon: '‚Çø',
                nativeCurrency: 'BTC',
                explorer: 'blockchain.info'
            },
            solana: {
                name: 'Solana',
                icon: '‚óé',
                nativeCurrency: 'SOL',
                explorer: 'solscan.io'
            },
            bsc: {
                name: 'BNB Chain',
                icon: 'üü°',
                nativeCurrency: 'BNB',
                explorer: 'bscscan.com'
            },
            polygon: {
                name: 'Polygon',
                icon: '‚¨°',
                nativeCurrency: 'MATIC',
                explorer: 'polygonscan.com'
            },
            avalanche: {
                name: 'Avalanche',
                icon: 'üî∫',
                nativeCurrency: 'AVAX',
                explorer: 'snowtrace.io'
            }
        };

        const personalities = {
            hodler: {
                name: 'The HODLer',
                icon: 'üíé',
                desc: 'You believe in long-term value and rarely sell. Diamond hands!',
                traits: [
                    'Strong conviction in your investments',
                    'Rarely panic sells during dips',
                    'Patient and strategic approach',
                    'Prefers holding quality assets'
                ]
            },
            daytrader: {
                name: 'The Day Trader',
                icon: 'üìà',
                desc: 'Active trader who loves riding the waves of market volatility.',
                traits: [
                    'Highly active with frequent transactions',
                    'Quick to spot opportunities',
                    'Comfortable with risk',
                    'Always watching the charts'
                ]
            },
            degen: {
                name: 'The Degen',
                icon: 'üé∞',
                desc: 'Risk-taker who loves trying new protocols and memecoins.',
                traits: [
                    'Early adopter of new projects',
                    'Loves the thrill of discovery',
                    'Not afraid to experiment',
                    'Always chasing the next big thing'
                ]
            },
            cautious: {
                name: 'The Cautious Investor',
                icon: 'üõ°Ô∏è',
                desc: 'Careful and methodical. You do your research before every move.',
                traits: [
                    'Prefers established projects',
                    'Risk-averse approach',
                    'Values security and stability',
                    'Makes calculated decisions'
                ]
            },
            whale: {
                name: 'The Whale',
                icon: 'üêã',
                desc: 'Significant holdings that can move markets. Big player energy.',
                traits: [
                    'Substantial portfolio value',
                    'Market influence',
                    'Strategic position sizing',
                    'Long-term vision'
                ]
            },
            defi: {
                name: 'DeFi Power User',
                icon: '‚ö°',
                desc: 'You live and breathe DeFi. Yield farming is your passion.',
                traits: [
                    'Heavy protocol interaction',
                    'Constantly seeking yield',
                    'Understands complex DeFi mechanics',
                    'Early DeFi adopter'
                ]
            },
            nftcollector: {
                name: 'NFT Collector',
                icon: 'üé®',
                desc: 'You appreciate digital art and collectibles.',
                traits: [
                    'Active in NFT markets',
                    'Curator of digital assets',
                    'Community-focused',
                    'Appreciates uniqueness'
                ]
            },
            newbie: {
                name: 'The Explorer',
                icon: 'üå±',
                desc: 'Just starting your crypto journey. Welcome!',
                traits: [
                    'New to the space',
                    'Learning and growing',
                    'Curious about crypto',
                    'Building experience'
                ]
            }
        };

        let selectedChain = null;
        let walletAddress = null;
        let chartInstance = null;
        const apiCache = new Map();

        // ==================== BLOCKCHAIN API FUNCTIONS ====================

        // Validate addresses
        function isValidEthereumAddress(address) {
            return /^0x[a-fA-F0-9]{40}$/.test(address);
        }

        function isValidBitcoinAddress(address) {
            return /^[13][a-km-zA-HJ-NP-Z1-9]{25,34}$/.test(address) || 
                   /^bc1[a-z0-9]{39,59}$/.test(address);
        }

        function isValidSolanaAddress(address) {
            return /^[1-9A-HJ-NP-Za-km-z]{32,44}$/.test(address);
        }

        // ETHEREUM API (works for ETH, BSC, Polygon, Avalanche)
        async function getEthereumData(address, chainType = 'ethereum') {
            if (!isValidEthereumAddress(address)) {
                throw new Error('Invalid Ethereum address format');
            }

            const apiEndpoint = chainType === 'bsc' ? API_CONFIG.etherscan.bsc : 
                              chainType === 'polygon' ? API_CONFIG.etherscan.polygon :
                              chainType === 'avalanche' ? API_CONFIG.avalanche.snowtrace :
                              API_CONFIG.etherscan.mainnet;

            const apiKey = chainType === 'avalanche' ? API_CONFIG.avalanche.key : API_CONFIG.etherscan.key;

            // Check cache
            const cacheKey = `${chainType}:${address}`;
            if (apiCache.has(cacheKey)) {
                const cached = apiCache.get(cacheKey);
                if (Date.now() - cached.timestamp < 300000) { // 5 min cache
                    return cached.data;
                }
            }

            updateLoadingStatus('Fetching transaction history...', 30);
            completeStep('step1');

            // Fetch transactions
            const txUrl = `${apiEndpoint}?module=account&action=txlist&address=${address}&startblock=0&endblock=99999999&page=1&offset=1000&sort=asc&apikey=${apiKey}`;
            
            const txResponse = await fetch(txUrl);
            const txData = await txResponse.json();

            if (txData.status !== '1') {
                throw new Error(txData.message || 'Failed to fetch transaction data');
            }

            completeStep('step2');
            updateLoadingStatus('Analyzing wallet...', 60);

            // Fetch balance
            const balanceUrl = `${apiEndpoint}?module=account&action=balance&address=${address}&tag=latest&apikey=${apiKey}`;
            
            const balResponse = await fetch(balanceUrl);
            const balData = await balResponse.json();

            const balance = parseFloat(balData.result) / 1e18;
            const transactions = txData.result;

            completeStep('step3');

            const result = analyzeEthereumWallet(address, transactions, balance, chainType);
            
            // Cache result
            apiCache.set(cacheKey, {
                data: result,
                timestamp: Date.now()
            });

            return result;
        }

        // BITCOIN API
        async function getBitcoinData(address) {
            if (!isValidBitcoinAddress(address)) {
                throw new Error('Invalid Bitcoin address format');
            }

            const cacheKey = `bitcoin:${address}`;
            if (apiCache.has(cacheKey)) {
                const cached = apiCache.get(cacheKey);
                if (Date.now() - cached.timestamp < 300000) {
                    return cached.data;
                }
            }

            updateLoadingStatus('Fetching Bitcoin data...', 30);
            completeStep('step1');

            const response = await fetch(`https://blockchain.info/rawaddr/${address}?limit=100`);
            
            if (!response.ok) {
                throw new Error('Failed to fetch Bitcoin data');
            }

            const data = await response.json();
            completeStep('step2');
            updateLoadingStatus('Analyzing wallet...', 60);
            completeStep('step3');

            const result = analyzeBitcoinWallet(address, data);

            apiCache.set(cacheKey, {
                data: result,
                timestamp: Date.now()
            });

            return result;
        }

        // SOLANA API
        async function getSolanaData(address) {
            if (!isValidSolanaAddress(address)) {
                throw new Error('Invalid Solana address format');
            }

            const cacheKey = `solana:${address}`;
            if (apiCache.has(cacheKey)) {
                const cached = apiCache.get(cacheKey);
                if (Date.now() - cached.timestamp < 300000) {
                    return cached.data;
                }
            }

            updateLoadingStatus('Fetching Solana data...', 30);
            completeStep('step1');

            // Get balance using public RPC
            const balanceResponse = await fetch('https://api.mainnet-beta.solana.com', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    jsonrpc: '2.0',
                    id: 1,
                    method: 'getBalance',
                    params: [address]
                })
            });

            const balanceData = await balanceResponse.json();
            const balance = balanceData.result?.value / 1e9 || 0;

            completeStep('step2');
            updateLoadingStatus('Analyzing transactions...', 60);

            // Get transaction signatures
            const sigResponse = await fetch('https://api.mainnet-beta.solana.com', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    jsonrpc: '2.0',
                    id: 1,
                    method: 'getSignaturesForAddress',
                    params: [address, { limit: 100 }]
                })
            });

            const sigData = await sigResponse.json();
            const transactions = sigData.result || [];

            completeStep('step3');

            const result = analyzeSolanaWallet(address, transactions, balance);

            apiCache.set(cacheKey, {
                data: result,
                timestamp: Date.now()
            });

            return result;
        }

        // ==================== WALLET ANALYSIS ====================

        function analyzeEthereumWallet(address, transactions, balance, chainType) {
            const txCount = transactions.length;

            // Calculate wallet age
            const firstTx = transactions[0];
            const walletAgeDays = firstTx ? 
                Math.floor((Date.now() - firstTx.timeStamp * 1000) / (1000 * 60 * 60 * 24)) : 0;

            // Calculate gas spent
            const totalGasSpent = transactions.reduce((sum, tx) => {
                return sum + (parseInt(tx.gasUsed || 0) * parseInt(tx.gasPrice || 0)) / 1e18;
            }, 0);

            // Contract interactions (DeFi activity)
            const contractInteractions = transactions.filter(tx => tx.to && tx.input !== '0x').length;
            const defiRatio = txCount > 0 ? contractInteractions / txCount : 0;

            // Activity level
            let activityLevel = 'Low';
            if (txCount > 100) activityLevel = 'Medium';
            if (txCount > 500) activityLevel = 'High';
            if (txCount > 1000) activityLevel = 'Very High';

            // Determine personality
            let personalityType = 'cautious';
            const insights = [];

            if (balance > 10) {
                personalityType = 'whale';
                insights.push(`You're a whale with ${balance.toFixed(2)} ${chains[chainType].nativeCurrency}!`);
                insights.push('Your wallet can make market moves');
            } else if (defiRatio > 0.6) {
                personalityType = 'defi';
                insights.push('You\'re heavily into DeFi protocols');
                insights.push(`${Math.round(defiRatio * 100)}% of your transactions are smart contract interactions`);
            } else if (balance > 1 && txCount < 50) {
                personalityType = 'hodler';
                insights.push('You have strong conviction in your holdings');
                insights.push(`Total gas spent: ${totalGasSpent.toFixed(4)} ${chains[chainType].nativeCurrency}`);
            } else if (txCount > 500) {
                personalityType = 'daytrader';
                insights.push('You\'re a highly active trader');
                insights.push(`Average ${(txCount / (walletAgeDays || 1)).toFixed(1)} transactions per day`);
            } else if (txCount > 100 && balance < 0.1) {
                personalityType = 'degen';
                insights.push('You love experimenting with new tokens');
                insights.push('High activity with moderate holdings');
            } else if (txCount < 10) {
                personalityType = 'newbie';
                insights.push('Welcome to the crypto space!');
                insights.push('You\'re just getting started on your journey');
            }

            // Historical data
            const historicalData = [];
            let runningBalance = 0;
            const monthlyData = {};

            transactions.forEach(tx => {
                const value = parseFloat(tx.value || 0) / 1e18;
                if (tx.from.toLowerCase() === address.toLowerCase()) {
                    runningBalance -= value;
                } else {
                    runningBalance += value;
                }

                const date = new Date(tx.timeStamp * 1000);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;

                if (!monthlyData[monthKey]) {
                    historicalData.push({
                        month: monthKey,
                        balance: Math.max(0, runningBalance)
                    });
                    monthlyData[monthKey] = true;
                }
            });

            return {
                personality: {
                    type: personalityType,
                    stats: {
                        txCount: txCount,
                        balance: `${balance.toFixed(4)} ${chains[chainType].nativeCurrency}`,
                        walletAge: `${walletAgeDays} days`,
                        activityLevel: activityLevel
                    },
                    insights: insights
                },
                txCount: txCount,
                balance: balance,
                historicalData: historicalData.slice(-12)
            };
        }

        function analyzeBitcoinWallet(address, data) {
            const balance = data.final_balance / 1e8;
            const txCount = data.n_tx;
            const totalReceived = data.total_received / 1e8;
            const totalSent = data.total_sent / 1e8;

            // Calculate hodl ratio
            const hodlRatio = totalReceived > 0 ? balance / totalReceived : 0;

            // Activity level
            let activityLevel = 'Low';
            if (txCount > 50) activityLevel = 'Medium';
            if (txCount > 200) activityLevel = 'High';
            if (txCount > 500) activityLevel = 'Very High';

            // Determine personality
            let personalityType = 'cautious';
            const insights = [];

            if (balance > 10) {
                personalityType = 'whale';
                insights.push(`Massive Bitcoin holdings: ${balance.toFixed(4)} BTC`);
                insights.push('You\'re a Bitcoin whale!');
            } else if (hodlRatio > 0.8 && txCount < 50) {
                personalityType = 'hodler';
                insights.push('Strong Bitcoin hodler with diamond hands');
                insights.push(`${Math.round(hodlRatio * 100)}% of received BTC is still held`);
            } else if (txCount > 200) {
                personalityType = 'daytrader';
                insights.push('Active Bitcoin trader');
                insights.push(`Total volume: ${totalReceived.toFixed(4)} BTC received`);
            } else if (txCount < 10) {
                personalityType = 'newbie';
                insights.push('New to Bitcoin!');
                insights.push('Building your first positions');
            }

            // Calculate wallet age (estimate from first tx)
            const firstTx = data.txs[data.txs.length - 1];
            const walletAgeDays = firstTx ? 
                Math.floor((Date.now() - firstTx.time * 1000) / (1000 * 60 * 60 * 24)) : 0;

            return {
                personality: {
                    type: personalityType,
                    stats: {
                        txCount: txCount,
                        balance: `${balance.toFixed(8)} BTC`,
                        walletAge: `${walletAgeDays} days`,
                        activityLevel: activityLevel
                    },
                    insights: insights
                },
                txCount: txCount,
                balance: balance,
                historicalData: []
            };
        }

        function analyzeSolanaWallet(address, transactions, balance) {
            const txCount = transactions.length;

            // Activity level
            let activityLevel = 'Low';
            if (txCount > 50) activityLevel = 'Medium';
            if (txCount > 200) activityLevel = 'High';
            if (txCount > 500) activityLevel = 'Very High';

            // Determine personality
            let personalityType = 'cautious';
            const insights = [];

            if (balance > 100) {
                personalityType = 'whale';
                insights.push(`Significant Solana holdings: ${balance.toFixed(2)} SOL`);
            } else if (txCount > 300) {
                personalityType = 'daytrader';
                insights.push('Very active on Solana');
                insights.push('You love the speed and low fees');
            } else if (txCount > 100) {
                personalityType = 'defi';
                insights.push('Active DeFi user on Solana');
                insights.push('You understand Solana\'s DeFi ecosystem');
            } else if (balance > 1 && txCount < 30) {
                personalityType = 'hodler';
                insights.push('Holding SOL for the long term');
            } else if (txCount < 10) {
                personalityType = 'newbie';
                insights.push('New to Solana!');
                insights.push('Exploring the ecosystem');
            }

            // Estimate wallet age
            const firstTx = transactions[transactions.length - 1];
            const walletAgeDays = firstTx?.blockTime ? 
                Math.floor((Date.now() - firstTx.blockTime * 1000) / (1000 * 60 * 60 * 24)) : 0;

            return {
                personality: {
                    type: personalityType,
                    stats: {
                        txCount: txCount,
                        balance: `${balance.toFixed(4)} SOL`,
                        walletAge: `${walletAgeDays} days`,
                        activityLevel: activityLevel
                    },
                    insights: insights
                },
                txCount: txCount,
                balance: balance,
                historicalData: []
            };
        }

        // ==================== UI FUNCTIONS ====================

        function selectChain(chain) {
            selectedChain = chain;
            const chainInfo = chains[chain];
            
            document.querySelectorAll('.chain-btn').forEach(btn => {
                btn.classList.remove('border-purple-600', 'bg-purple-100');
            });
            event.target.closest('.chain-btn').classList.add('border-purple-600', 'bg-purple-100');
            
            document.getElementById('selectedChainInfo').classList.remove('hidden');
            document.getElementById('selectedChainName').textContent = chainInfo.name;
            
            document.getElementById('connectWalletBtn').disabled = false;
            document.getElementById('manualAddress').disabled = false;
            document.getElementById('analyzeAddressBtn').disabled = false;
        }

        async function connectWallet() {
            if (!selectedChain) return;

            try {
                showLoading();
                document.getElementById('selectedChainDisplay').textContent = `Analyzing ${chains[selectedChain].name} wallet...`;
                
                if (selectedChain === 'ethereum' || selectedChain === 'bsc' || selectedChain === 'polygon' || selectedChain === 'avalanche') {
                    if (typeof window.ethereum !== 'undefined') {
                        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                        walletAddress = accounts[0];
                        
                        const result = await getEthereumData(walletAddress, selectedChain);
                        completeStep('step4');
                        updateLoadingStatus('Complete!', 100);
                        
                        setTimeout(() => {
                            showResults(result.personality, result.txCount, result.balance, result.historicalData);
                        }, 500);
                    } else {
                        showError('Please install MetaMask to connect your Ethereum wallet');
                    }
                } else if (selectedChain === 'solana') {
                    if (window.solana && window.solana.isPhantom) {
                        const response = await window.solana.connect();
                        walletAddress = response.publicKey.toString();
                        
                        const result = await getSolanaData(walletAddress);
                        completeStep('step4');
                        updateLoadingStatus('Complete!', 100);
                        
                        setTimeout(() => {
                            showResults(result.personality, result.txCount, result.balance, result.historicalData);
                        }, 500);
                    } else {
                        showError('Please install Phantom wallet to connect your Solana wallet');
                    }
                } else {
                    showError('Wallet connection not available for this chain. Please enter address manually.');
                }
            } catch (error) {
                console.error('Error:', error);
                showError(error.message || 'Failed to analyze wallet. Please try again.');
            }
        }

        async function analyzeManualAddress() {
            const address = document.getElementById('manualAddress').value.trim();
            
            if (!address) {
                alert('Please enter a wallet address');
                return;
            }

            if (!selectedChain) {
                alert('Please select a blockchain first');
                return;
            }

            try {
                walletAddress = address;
                showLoading();
                document.getElementById('selectedChainDisplay').textContent = `Analyzing ${chains[selectedChain].name} wallet...`;
                
                let result;
                if (selectedChain === 'ethereum' || selectedChain === 'bsc' || selectedChain === 'polygon' || selectedChain === 'avalanche') {
                    result = await getEthereumData(address, selectedChain);
                } else if (selectedChain === 'bitcoin') {
                    result = await getBitcoinData(address);
                } else if (selectedChain === 'solana') {
                    result = await getSolanaData(address);
                } else {
                    throw new Error('Chain not supported yet');
                }

                completeStep('step4');
                updateLoadingStatus('Complete!', 100);
                
                setTimeout(() => {
                    showResults(result.personality, result.txCount, result.balance, result.historicalData);
                }, 500);
                
            } catch (error) {
                console.error('Error:', error);
                showError(error.message || 'Failed to analyze wallet. Please check the address and try again.');
            }
        }

        function createPortfolioChart(historicalData) {
            const canvas = document.getElementById('portfolioChart');
            const ctx = canvas.getContext('2d');
            
            if (chartInstance) {
                chartInstance.destroy();
            }

            const chainInfo = chains[selectedChain];
            
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: historicalData.map(d => d.month),
                    datasets: [{
                        label: `Balance (${chainInfo.nativeCurrency})`,
                        data: historicalData.map(d => d.balance),
                        borderColor: 'rgb(147, 51, 234)',
                        backgroundColor: 'rgba(147, 51, 234, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: 'rgb(147, 51, 234)',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    return `${chainInfo.nativeCurrency}: ${context.parsed.y.toFixed(4)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(2);
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
        }

        function showResults(personality, txCount, balance, historicalData) {
            const p = personalities[personality.type];
            const chainInfo = chains[selectedChain];
            
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('resultsScreen').classList.remove('hidden');
            
            document.getElementById('resultChainIcon').textContent = chainInfo.icon;
            document.getElementById('resultChainName').textContent = chainInfo.name;
            document.getElementById('personalityIcon').textContent = p.icon;
            document.getElementById('personalityType').textContent = p.name;
            document.getElementById('personalityDesc').textContent = p.desc;
            document.getElementById('statTxCount').textContent = personality.stats.txCount;
            document.getElementById('statWalletAge').textContent = personality.stats.walletAge;
            document.getElementById('statBalance').textContent = personality.stats.balance;
            document.getElementById('statActivity').textContent = personality.stats.activityLevel;
            
            const traitsList = document.getElementById('traits');
            traitsList.innerHTML = '';
            p.traits.forEach(trait => {
                const li = document.createElement('li');
                li.className = 'flex items-start';
                li.innerHTML = `<span class="text-purple-600 mr-3 text-xl">‚úì</span><span class="text-gray-700">${trait}</span>`;
                traitsList.appendChild(li);
            });
            
            const insightsDiv = document.getElementById('insights');
            insightsDiv.innerHTML = '';
            personality.insights.forEach(insight => {
                const p = document.createElement('p');
                p.className = 'flex items-start';
                p.innerHTML = `<span class="mr-2">üí°</span><span>${insight}</span>`;
                insightsDiv.appendChild(p);
            });
            
            const shortAddress = walletAddress.slice(0, 6) + '...' + walletAddress.slice(-4);
            document.getElementById('walletAddress').textContent = shortAddress;
            
            if (historicalData && historicalData.length > 0) {
                createPortfolioChart(historicalData);
            }
        }

        function showLoading() {
            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('loadingScreen').classList.remove('hidden');
        }

        function updateLoadingStatus(message, progress) {
            document.getElementById('loadingStatus').textContent = message;
            document.getElementById('loadingBar').style.width = progress + '%';
        }

        function completeStep(stepId) {
            const step = document.getElementById(stepId);
            step.classList.remove('text-gray-400');
            step.classList.add('text-green-600', 'font-semibold');
            step.querySelector('span').textContent = '‚úì';
        }

        function showError(message) {
            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('errorScreen').classList.remove('hidden');
            document.getElementById('errorMessage').textContent = message;
        }

        function restartTest() {
            selectedChain = null;
            walletAddress = null;
            document.getElementById('resultsScreen').classList.add('hidden');
            document.getElementById('errorScreen').classList.add('hidden');
            document.getElementById('startScreen').classList.remove('hidden');
            document.getElementById('selectedChainInfo').classList.add('hidden');
            document.getElementById('manualAddress').value = '';
            document.querySelectorAll('.chain-btn').forEach(btn => btn.classList.remove('border-purple-600', 'bg-purple-100'));
            document.getElementById('connectWalletBtn').disabled = true;
            document.getElementById('manualAddress').disabled = true;
            document.getElementById('analyzeAddressBtn').disabled = true;
            ['step1', 'step2', 'step3', 'step4'].forEach(id => {
                const step = document.getElementById(id);
                step.classList.remove('text-green-600', 'font-semibold');
                step.classList.add('text-gray-400');
                step.querySelector('span').textContent = '‚óã';
            });
        }

        function shareResults() {
            const personalityName = document.getElementById('personalityType').textContent;
            const icon = document.getElementById('personalityIcon').textContent;
            const chainInfo = chains[selectedChain];
            const text = `I just analyzed my ${chainInfo.name} wallet and I'm ${icon} ${personalityName}! Find out your crypto personality!`;
            
            if (navigator.share) {
                navigator.share({ 
                    title: 'My Crypto Personality', 
                    text: text 
                });
            } else {
                navigator.clipboard.writeText(text).then(() => {
                    alert('Results copied to clipboard!');
                });
            }
        }
    </script>
</body>
</html>
